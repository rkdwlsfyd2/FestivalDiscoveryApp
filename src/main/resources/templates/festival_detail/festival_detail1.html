<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  lang="ko"
	  layout:decorate="common/mylayout"> <!-- 506690, 2557842, 3379778 -->
	<head>
		<meta charset="UTF-8">
		<title>축제 상세 보기</title>

		<!-- 이 페이지 전용 최소 CSS -->
		<style>
			/* 페이지 전체 폭/여백 */
			.page-wrap {
				max-width: 960px;
				margin: 24px auto 80px;
				padding: 0 16px;
			}

			/* 카드 컴포넌트: 배경·라운드·그림자 */
			.card {
				background: #ffffff;
				border-radius: 8px;
				padding: 24px;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
				margin-bottom: 24px;
			}

			/* 상태/리뷰 요약 줄 */
			.fd-badge-row {
				display: flex;
				gap: 8px;
				align-items: center;
				margin: 6px 0;
				flex-wrap: wrap;
			}

			/* 상태 배지 공통 */
			.fd-status-badge {
				display: inline-flex;
				align-items: center;
				padding: 4px 10px;
				border-radius: 999px;
				font-size: 12px;
				font-weight: 600;
			}

			/* 진행 중 / 종료 색상 (진행 예정은 bg-main 유틸 사용) */
			.fd-status-badge--ongoing {
				background: #22c55e;
				color: #ffffff;
			}

			.fd-status-badge--finished {
				background: #9ca3af;
				color: #ffffff;
			}

			/* 날짜·주소 메타 정보 */
			.fd-meta {
				font-size: 13px;
				color: #444444;
				margin-top: 4px;
			}

			.fd-meta span {
				display: inline-block;
				margin-right: 12px;
			}

			/* 제목 옆 태그 칩: 모양만, 색은 bg-sub-blue / text-main 으로 처리 */
			.fd-tag-chip {
				display: inline-block;
				font-size: 12px;
				padding: 3px 8px;
				border-radius: 999px;
				margin-right: 4px;
			}

			/* 상단 좌/우 레이아웃 */
			.fd-top-layout {
				display: flex;
				align-items: flex-start;
				gap: 24px;
				margin-top: 12px;
			}

			.fd-top-left {
				flex: 3;
			}

			.fd-top-right {
				flex: 2;
				border-left: 1px solid #f0f0f0;
				padding-left: 16px;
			}

			/* 기본 정보 리스트 */
			.fd-info-list {
				list-style: none;
				padding: 0;
				margin: 8px 0 0;
				font-size: 13px;
			}

			.fd-info-list li {
				margin-bottom: 6px;
			}

			.fd-info-list strong {
				display: inline-block;
				width: 60px;
				color: #555555;
			}

			/* 리뷰 카드 내부 */
			.fd-review-item {
				border-top: 1px solid #eeeeee;
				padding-top: 10px;
				margin-top: 10px;
			}

			.fd-review-meta {
				font-size: 12px;
				color: #777777;
				margin-bottom: 4px;
				display: inline-block;
			}

			.fd-review-text {
				margin-top: 4px;
			}

			/* 별점 표시 ===================== */
			/* 공통: 별 컨테이너 */
			.star-rating {
				display: inline-flex;
				line-height: 1;
			}

			/* 공통: 별 한 개 */
			.star {
				position: relative;
				display: inline-block;
				width: 1em;
				height: 1em;
				margin-right: 1px;
			}

			/* 기본: 빈 별(회색) */
			.star::before {
				content: '★';
				position: absolute;
				left: 0;
				top: 0;
				color: #e5e7eb;
			}

			/* 꽉 찬 별 */
			.star-full::before {
				color: #fbbf24;
			}

			/* 반 별: 회색 + 노란색 절반 */
			.star-half::before {
				color: #e5e7eb;
			}
			.star-half::after {
				content: '★';
				position: absolute;
				left: 0;
				top: 0;
				color: #fbbf24;
				width: 70%;
				overflow: hidden;
				clip-path: inset(0 30% 0 0);
			}

			/* 목록(이미 작성된 리뷰)에서 쓰는 별 크기 */
			.star-rating--list {
				font-size: 18px;
			}

			/* 리뷰 작성 폼에서 쓰는 별 크기 (좀 더 크게) */
			.star-rating--input {
				font-size: 22px;
			}

			/* 리뷰 상단(이름 · 별점 · 날짜) 한 줄 정렬 */
			.fd-review-header {
				display: flex;
				align-items: center;
				gap: 4px;
			}

			/* 메타 텍스트는 살짝 작게 */
			.fd-review-header .fd-review-meta {
				margin-bottom: 0;
				font-size: 13px;
				color: #777777;
			}


			/* 점수 텍스트 */
			.rating-value {
				font-size: 14px;
				color: #555555;
			}


			/* 축제 소개/내용 2단 레이아웃 */
			.fd-intro-layout {
				display: flex;
				align-items: flex-start;
				gap: 24px;
			}

			/* 각 컬럼 */
			.fd-intro-col {
				flex: 1;
			}

			/* 화면이 좁으면 위/아래로 쌓기 */
			@media (max-width: 768px) {
				.fd-intro-layout {
					flex-direction: column;
				}
			}

			/* 기본 정보 리스트 */
			.fd-info-list {
				list-style: none;
				padding: 0;
				margin: 8px 0 0;
				font-size: 13px;
			}

			/* 한 줄 전체를 가로 정렬 */
			.fd-info-list li {
				display: flex;
				align-items: flex-start;
				margin-bottom: 6px;
			}

			/* 왼쪽 라벨(기간/장소/주최/문의/홈페이지) */
			.fd-info-list strong {
				flex: 0 0 60px;
				color: #555555;
			}

			/* 오른쪽 값(텍스트)만 폭 채우기 */
			.fd-info-list span {
				flex: 1;
			}

			/* 버튼은 내용 길이만큼만 나오도록 */
			.fd-info-list a {
				flex: 0 0 auto;
				display: inline-block;
				white-space: nowrap; /* 줄바꿈 방지(선택) */
			}

			#ratingBox .star {
				cursor: pointer;
			}

			/* 이미 작성된 리뷰 한 줄 (이름 · 별점 · 날짜) */
			.fd-review-header {
				display: flex;
				align-items: center;
				gap: 4px;
			}

			/* 목록용 별은 텍스트랑 baseline 살짝 맞춰주기 */
			.fd-review-header .star-rating {
				font-size: 18px;      /* 이미 있으니 중복이면 하나로 합쳐도 됨 */
				line-height: 1;
				position: relative;
				top: 1px;             /* 1~2px 사이에서 취향껏 조절 */
			}

		</style>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const container = document.getElementById('imageSliderContainer');
				const prevBtn = document.getElementById('prevImageBtn');
				const nextBtn = document.getElementById('nextImageBtn');
				const info = document.getElementById('imageSliderInfo');

				const modal = document.getElementById('imageModal');
				const modalImg = document.getElementById('modalImage');
				const modalClose = document.getElementById('modalCloseBtn');
				const modalPrev = document.getElementById('modalPrevBtn');
				const modalNext = document.getElementById('modalNextBtn');

				if (!container) return;
				const images = container.querySelectorAll('img');
				if (!images || images.length === 0) return;

				let currentIndex = 0;

				function showImage(index) {
					for (let i = 0; i < images.length; i++) {
						images[i].style.display = (i === index) ? '' : 'none';
					}
					if (info) {
						info.textContent = (index + 1) + ' / ' + images.length;
					}
					if (modal && modal.style.display === 'flex') {
						modalImg.src = images[index].src;
					}
				}

				function openModal(index) {
					if (!modal) return;
					modal.style.display = 'flex';
					modalImg.src = images[index].src;
				}

				function closeModal() {
					if (!modal) return;
					modal.style.display = 'none';
				}

				showImage(currentIndex);

				if (prevBtn) {
					prevBtn.addEventListener('click', function () {
						currentIndex = (currentIndex - 1 + images.length) % images.length;
						showImage(currentIndex);
					});
				}

				if (nextBtn) {
					nextBtn.addEventListener('click', function () {
						currentIndex = (currentIndex + 1) % images.length;
						showImage(currentIndex);
					});
				}

				if (container) {
					container.addEventListener('click', function () {
						openModal(currentIndex);
					});
				}

				if (modalClose) {
					modalClose.addEventListener('click', function () {
						closeModal();
					});
				}

				if (modal) {
					modal.addEventListener('click', function (e) {
						if (e.target === modal) {
							closeModal();
						}
					});
				}

				if (modalPrev) {
					modalPrev.addEventListener('click', function (e) {
						e.stopPropagation();
						currentIndex = (currentIndex - 1 + images.length) % images.length;
						showImage(currentIndex);
					});
				}

				if (modalNext) {
					modalNext.addEventListener('click', function (e) {
						e.stopPropagation();
						currentIndex = (currentIndex + 1) % images.length;
						showImage(currentIndex);
					});
				}

				/* ===== 리뷰 별점 입력 (hover + 0.5 단위) ===== */
				const ratingBox       = document.getElementById('ratingBox');       // 별 5개 컨테이너
				const ratingInput     = document.getElementById('ratingInput');     // hidden input
				const ratingValueText = document.getElementById('ratingValueText'); // "4.5점" 표시용

				if (ratingBox && ratingInput) {
					const stars = ratingBox.querySelectorAll('.star');
					// 현재 확정된 점수 (기본 0)
					let currentRating = parseFloat(ratingInput.value || '0') || 0;

					// 별 칠하기 (꽉찬/반/빈)
					function paintStars(rating) {
						stars.forEach(star => {
							const i = Number(star.getAttribute('data-index')); // 1~5
							star.classList.remove('star-full', 'star-half', 'star-empty');

							if (rating >= i) {
								// i 이상 → 꽉 찬 별
								star.classList.add('star-full');
							} else if (rating >= i - 0.5) {
								// i-0.5 이상, i 미만 → 반 별
								star.classList.add('star-half');
							} else {
								// 그 외 → 빈 별
								star.classList.add('star-empty');
							}
						});

						if (ratingValueText) {
							ratingValueText.textContent = rating > 0 ? rating.toFixed(1) + '점' : '';
						}
					}

					// 이벤트 기준으로 점수 계산 (0.5 단위)
					function calcRatingFromEvent(star, event) {
						const index = Number(star.getAttribute('data-index')); // 1~5
						const rect  = star.getBoundingClientRect();
						const x     = event.clientX - rect.left;
						const half  = rect.width / 2;

						// 왼쪽 절반 → index-0.5, 오른쪽 절반 → index
						return (x <= half) ? (index - 0.5) : index;
					}

					// 초기 표시
					paintStars(currentRating);

					// 각 별에 hover / click 이벤트
					stars.forEach(star => {
						// 마우스 움직이면 미리보기
						star.addEventListener('mousemove', e => {
							const hoverRating = calcRatingFromEvent(star, e);
							paintStars(hoverRating);
						});

						// 클릭하면 값 확정
						star.addEventListener('click', e => {
							const newRating = calcRatingFromEvent(star, e);
							currentRating   = newRating;
							ratingInput.value = newRating;
							paintStars(newRating);
						});
					});

					// 영역에서 마우스가 빠져나가면 마지막 확정 값으로 되돌리기
					ratingBox.addEventListener('mouseleave', () => {
						paintStars(currentRating);
					});
				}

				// ===== 축제 내용 줄바꿈 처리 (1. 2. 3. …) =====
				const contentEl = document.getElementById('festivalContent');
				if (contentEl) {
					const raw = contentEl.textContent || '';

					// " 2.", " 3.", " 4.", " 5." 앞에 <br><br> 삽입
					const formatted = raw.replace(/\s([2-9]\.\s)/g, '<br>$1');

					// HTML로 넣어서 줄바꿈 반영
					contentEl.innerHTML = formatted;
				}

			});
		</script>
	</head>
	<body>
		<section layout:fragment="content" class="festival-detail-page">
			<div class="page-wrap">

				<!-- A. 상단: 제목 + 태그 + 상태 + (왼)이미지 / (오른쪽)기본정보 -->
				<div class="card">
					<header>
						<!-- 1. 축제명, 태그 -->
						<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
							<!-- 축제명 -->
							<h1 class="text-h1 font-bold" th:text="${festival.title}"></h1>

							<!-- 태그 -->
							<div>
								<span class="fd-tag-chip bg-sub-blue" th:each="tag : ${festival.tags}" th:text="${tag.tag}"></span>
							</div>
						</div>

						<!-- 2. 진행 상태, 리뷰 요약 -->
						<div class="fd-badge-row">
							<!-- 진행 상태 -->
							<th:block th:with="today=${T(java.time.LocalDate).now()},
											   start=${festival.eventStartDate.toLocalDate()},
											   end=${festival.eventEndDate.toLocalDate()}">
								<!-- 진행 예정 -->
								<span class="fd-status-badge bg-main text-foreground" th:if="${today.isBefore(start)}">
									축제 진행 예정
								</span>

								<!-- 진행 중 -->
								<span class="fd-status-badge fd-status-badge--ongoing" th:if="${!today.isBefore(start) and !today.isAfter(end)}">
									축제 진행 중
								</span>
								<!-- 종료 -->
								<span class="fd-status-badge fd-status-badge--finished" th:if="${today.isAfter(end)}">
									축제 종료
								</span>
							</th:block>

							<!-- 리뷰 요약 -->
							<span class="text-subtext" th:text="|⭐ ${#numbers.formatDecimal(festival.avgRating, 1, 1)} / 5.0|"></span>
							<span class="text-subtext text-gray-600" th:text="|리뷰 (${festival.reviews.size()}개)|"></span>
						</div>
					</header>

					<div class="fd-top-layout">
						<!-- 3. 이미지 슬라이더 -->
						<div class="fd-top-left">
							<section>
								<div style="width: 100%;
											max-width: 420px;
											margin: 0 auto;
											display: flex;
											align-items: center;
											justify-content: center;">
									<button type="button" id="prevImageBtn" style="margin-right: 8px;">◀</button>

									<div id="imageSliderContainer"
										 style="width: 100%;
												height: 260px;
												display: flex;
												align-items: center;
												justify-content: center;
												overflow: hidden;
												cursor: pointer;
												background: #000000;">
										<img th:each="image : ${festival.images}"
											 th:src="${image.imageUrl}"
											 th:alt="${image.imageUrl}"
											 style="max-width: 100%;
													max-height: 100%;
													width: auto;
													height: auto;">
									</div>

									<button type="button" id="nextImageBtn" style="margin-left: 8px;">▶</button>
								</div>

								<p id="imageSliderInfo"
								   class="text-subtext"
								   style="text-align: center;
										  margin-top: 6px;
										  color: #666666;"></p>

								<!-- 모달 -->
								<div id="imageModal"
									 style="display: none;
											position: fixed;
											left: 0;
											top: 0;
											width: 100%;
											height: 100%;
											background: rgba(0,0,0,0.7);
											z-index: 9999;
											align-items: center;
											justify-content: center;">
									<button id="modalCloseBtn"
											type="button"
											style="position: absolute;
												   top: 16px;
												   right: 24px;
												   font-size: 24px;
												   border: none;
												   background: none;
												   color: #ffffff;
												   cursor: pointer;">
										✕
									</button>

									<button id="modalPrevBtn"
											type="button"
											style="position: absolute;
												   left: 16px;
												   font-size: 32px;
												   border: none;
												   background: none;
												   color: #ffffff;
												   cursor: pointer;">
										◀
									</button>

									<button id="modalNextBtn"
											type="button"
											style="position: absolute;
												   right: 16px;
												   font-size: 32px;
												   border: none;
												   background: none;
												   color: #ffffff;
												   cursor: pointer;">
										▶
									</button>

									<img id="modalImage"
										 src=""
										 alt="원본 이미지"
										 style="max-width: 90%;
												max-height: 90%;
												box-shadow: 0 0 12px rgba(0,0,0,0.5);
												background: #ffffff;">
								</div>
							</section>
						</div>

						<!-- 4. 기본 정보 -->
						<div class="fd-top-right">
							<section>
								<h2 class="text-h3 font-semibold mb-2">기본 정보</h2>
								<ul class="fd-info-list">
									<li>
										<strong>기간</strong>
										<span th:text="|${festival.eventStartDate.toLocalDate()} ~ ${festival.eventEndDate.toLocalDate()}|"></span>
									</li>
									<li>
										<strong>장소</strong>
										<span th:text="${festival.addr}"></span>
									</li>
									<li>
										<strong>요금</strong>
										<span th:text="${festival.detail.festivalFee}"></span>
									</li>
									<li>
										<strong>주최</strong>
										<span th:text="${festival.detail.host}"></span>
									</li>
									<li>
										<strong>문의</strong>
										<span th:text="${festival.detail.hostTel}"></span>
									</li>
									<li>
										<strong>홈페이지</strong>
										<a th:href="${festival.detail.homepage}"
										   target="_blank"
										   class="text-subtext text-foreground bg-main"
										   style="display:inline-block;
												  margin-left:4px;
												  padding:6px 10px;
												  border-radius:4px;
												  text-decoration:none;">
											홈페이지 바로가기
										</a>
									</li>
								</ul>
							</section>
						</div>
					</div>
				</div>

				<!-- B. 리뷰 -->
				<div class="card" id="reviewSection">
					<h2 class="text-h3 font-semibold mb-3">리뷰</h2>
					<p class="text-body" style="margin-bottom: 8px;">
						평균 평점
						<strong th:text="|⭐ ${#numbers.formatDecimal(festival.avgRating, 1, 1)} / 5.0 · 리뷰 ${festival.reviews.size()}개|"></strong>
					</p>

					<div class="fd-review-item" th:each="review : ${festival.reviews}">
						<!-- 한 줄에 이름 · 별점 · 날짜 -->
						<div class="fd-review-header">
							<span class="fd-review-meta" th:text="${review.member.name}"></span>
							<span class="fd-review-meta">·</span>

							<!-- 목록용 별점 -->
							<span class="star-rating star-rating--list">
								<span th:each="i : ${#numbers.sequence(1,5)}">
									<!-- 꽉 찬 별 -->
									<span class="star star-full"
										  th:if="${review.rating >= i}"></span>

									<!-- 반 별: (i-0.5) 이상, i 미만 -->
									<span class="star star-half"
										  th:if="${review.rating < i and review.rating >= i - 0.5}"></span>

									<!-- 빈 별 -->
									<span class="star star-empty"
										  th:if="${review.rating < i - 0.5}"></span>
								</span>
							</span>
							<span class="fd-review-meta">·</span>
							<span class="fd-review-meta" th:text="${#temporals.format(review.updatedAt, 'yyyy-MM-dd HH:mm:ss')}"></span>
						</div>

						<!-- 내용 -->
						<div class="fd-review-text text-body" th:text="${review.content}"></div>
					</div>

					<!-- 구분선 -->
					<hr style="margin: 16px 0; border: none; border-top: 1px solid #eeeeee;">

					<!-- 리뷰 작성 폼 -->
					<h3 class="text-h3 font-semibold mb-2">리뷰 작성</h3>
					<form th:action="@{/festivals/reviews(festivalNo=${festival.festivalNo})}" method="post" class="space-y-3">
						<!-- 별점 선택 (.5 단위) -->
						<div class="text-body" style="margin-bottom: 8px;">
							<!-- ★ 별점 입력 영역 -->
							<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
								<label class="text-subtext">별점</label>
								<div id="ratingBox" class="star-rating star-rating--input">
								<span class="star" data-index="1"></span>
									<span class="star" data-index="2"></span>
									<span class="star" data-index="3"></span>
									<span class="star" data-index="4"></span>
									<span class="star" data-index="5"></span>
								</div>

								<!-- 현재 선택된 점수 표시 -->
								<span id="ratingValueText" class="text-subtext"></span>

								<!-- 실제 서버로 보내는 값 -->
								<input type="hidden" id="ratingInput" name="rating" value="0">
							</div>

							<!-- 선택된 점수 텍스트 -->
							<span class="text-subtext" id="ratingLabel"></span>
						</div>


						<!-- 내용 입력 -->
						<div class="text-body">
							<label class="text-subtext block mb-1">내용</label>
							<textarea name="content"
									  rows="2"
									  class="w-full border rounded px-3 py-2 text-body"
									  placeholder="축제에 대한 후기를 자유롭게 남겨 주세요."></textarea>
						</div>

						<!-- 제출 버튼 -->
						<div>
							<button type="submit"
									class="bg-main text-foreground text-subtext px-4 py-2 rounded">
								리뷰 등록
							</button>
						</div>
					</form>
				</div>

				<!-- C. 축제 소개 -->
				<div class="card">
					<div class="fd-intro-layout">
						<!-- 왼쪽: 축제 소개 (infotext1) -->
						<section class="fd-intro-col">
							<h2 class="text-h3 font-semibold mb-3">축제 소개</h2>
							<p class="text-body" th:text="${festival.detail.infotext1}"></p>
						</section>

						<!-- 오른쪽: 축제 내용 (infotext2 있을 때만) -->
						<section class="fd-intro-col"
								 th:if="${festival.detail.infotext2 != null and !#strings.isEmpty(festival.detail.infotext2)}">
							<h2 class="text-h3 font-semibold mb-3">축제 내용</h2>
							<p id="festivalContent" class="text-body"
							   th:text="${festival.detail.infotext2}"></p>
						</section>

					</div>
				</div>


				<!-- D. 위치 안내 -->
				<div class="card">
					<h2 class="text-h3 font-semibold mb-3">위치 안내</h2>
					<div id="map" style="width:100%; height:260px;"></div>
					<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=022dfc0274bfeb04bf381c2437e71f95"></script>
					<script th:inline="javascript">
						document.addEventListener('DOMContentLoaded', function () {
							var container = document.getElementById('map');
							if (!container) return;

							var options = {
								center: new kakao.maps.LatLng([[${festival.mapy}]], [[${festival.mapx}]]),
								level: 3,
								draggable: false
							};

							var map = new kakao.maps.Map(container, options);

							var markerPosition = new kakao.maps.LatLng([[${festival.mapy}]], [[${festival.mapx}]]);

							var marker = new kakao.maps.Marker({
								position: markerPosition
							});

							marker.setMap(map);
						});
					</script>
					<p class="text-subtext"
					   style="margin-top: 8px;
							  color: #555555;"
					   th:text="${festival.addr}">
					</p>
				</div>
			</div>
		</section>
	</body>
</html>
