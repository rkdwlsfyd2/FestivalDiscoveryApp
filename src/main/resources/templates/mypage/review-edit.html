<!-- review-edit.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">



	<th:block layout:fragment="css">
		<style>
			/* ========= ë³„ì  ê³µí†µ ìŠ¤íƒ€ì¼ (ì¶•ì œ ìƒì„¸ì™€ ë™ì¼) ========= */

			/* ê³µí†µ: ë³„ ì»¨í…Œì´ë„ˆ */
			.star-rating {
				display: inline-flex;
				line-height: 1;
			}

			/* ê³µí†µ: ë³„ í•œ ê°œ */
			.star {
				position: relative;
				display: inline-block;
				width: 1em;
				height: 1em;
				margin-right: 1px;
			}

			/* ê¸°ë³¸: ë¹ˆ ë³„(íšŒìƒ‰) */
			.star::before {
				content: 'â˜…';
				position: absolute;
				left: 0;
				top: 0;
				color: #e5e7eb;
			}

			/* ê½‰ ì°¬ ë³„ */
			.star-full::before {
				color: #fbbf24;
			}

			/* ë°˜ ë³„: íšŒìƒ‰ + ë…¸ë€ìƒ‰ ì ˆë°˜ */
			.star-half::before {
				color: #e5e7eb;
			}
			.star-half::after {
				content: 'â˜…';
				position: absolute;
				left: 0;
				top: 0;
				color: #fbbf24;
				width: 70%;
				overflow: hidden;
				clip-path: inset(0 30% 0 0);
			}

			/* ë¹ˆ ë³„ */
			.star-empty::before {
				color: #e5e7eb;
			}

			/* ëª©ë¡(ì´ë¯¸ ì‘ì„±ëœ ë¦¬ë·°)ì—ì„œ ì“°ëŠ” ë³„ í¬ê¸° */
			.star-rating--list {
				font-size: 18px;
			}

			/* ë¦¬ë·° ì‘ì„±/ìˆ˜ì • í¼ì—ì„œ ì“°ëŠ” ë³„ í¬ê¸° (ì¢€ ë” í¬ê²Œ) */
			.star-rating--input {
				font-size: 22px;
			}

			/* ì…ë ¥ìš© ë³„ì€ ë§ˆìš°ìŠ¤ í¬ì¸í„° í‘œì‹œ */
			#ratingBox .star {
				cursor: pointer;
			}

			/* ì ìˆ˜ í…ìŠ¤íŠ¸ (ì„ íƒ) */
			.rating-value {
				font-size: 14px;
				color: #555555;
			}
		</style>
	</th:block>

	<th:block layout:fragment="script">
		<script>
			document.addEventListener('DOMContentLoaded', function () {

				// ===== ë¦¬ë·° ë³„ì  ì…ë ¥ (hover + 0.5 ë‹¨ìœ„) =====
				const ratingBox       = document.getElementById('ratingBox');       // ë³„ 5ê°œ ì»¨í…Œì´ë„ˆ
				const ratingInput     = document.getElementById('ratingInput');     // hidden input
				const ratingValueText = document.getElementById('ratingValueText'); // "4.5ì " í‘œì‹œìš©

				if (ratingBox && ratingInput) {
					const stars = ratingBox.querySelectorAll('.star');
					let currentRating = parseFloat(ratingInput.value || '0') || 0;

					function paintStars(rating) {
						stars.forEach(star => {
							const i = Number(star.getAttribute('data-index')); // 1~5
							star.classList.remove('star-full', 'star-half', 'star-empty');

							if (rating >= i) {
								star.classList.add('star-full');
							} else if (rating >= i - 0.5) {
								star.classList.add('star-half');
							} else {
								star.classList.add('star-empty');
							}
						});

						if (ratingValueText) {
							if (rating <= 0) {
								ratingValueText.textContent = '';
								return;
							}

							let msg = '';
							if (rating >= 4.5)      msg = 'ì•„ì£¼ ì¢‹ì•„ìš” ğŸ‘';
							else if (rating >= 3.5) msg = 'ì¢‹ì•„ìš” ğŸ™‚';
							else if (rating >= 2.5) msg = 'ë³´í†µì´ì—ìš” ğŸ˜';
							else                    msg = 'ì¡°ê¸ˆ ì•„ì‰¬ì›Œìš” ğŸ˜¢';

							ratingValueText.textContent = `${msg} (${rating.toFixed(1)}ì )`;
						}
					}

					function calcRatingFromEvent(star, event) {
						const index = Number(star.getAttribute('data-index'));
						const rect  = star.getBoundingClientRect();
						const x     = event.clientX - rect.left;
						const half  = rect.width / 2;

						return (x <= half) ? (index - 0.5) : index;
					}

					// ì´ˆê¸° í‘œì‹œ (ê¸°ì¡´ ë¦¬ë·° ì ìˆ˜ í‘œì‹œ)
					paintStars(currentRating);

					stars.forEach(star => {
						star.addEventListener('mousemove', e => {
							const hoverRating = calcRatingFromEvent(star, e);
							paintStars(hoverRating);
						});

						star.addEventListener('click', e => {
							const newRating = calcRatingFromEvent(star, e);
							currentRating   = newRating;
							ratingInput.value = newRating;
							paintStars(newRating);
						});
					});

					ratingBox.addEventListener('mouseleave', () => {
						paintStars(currentRating);
					});
				}

				// ===== ë¦¬ë·° í¼ ìœ íš¨ì„± ê²€ì‚¬ (ì¶•ì œ ìƒì„¸ì™€ ë™ì¼ ë¡œì§) =====
				const reviewForm = document.querySelector('form[data-review-form="true"]');

				if (reviewForm) {
					const ratingInputEl   = document.getElementById('ratingInput');
					const contentTextarea = reviewForm.querySelector('textarea[name="content"]');

					reviewForm.addEventListener('submit', function (e) {
						// rating ê°’ íŒŒì‹± (ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬)
						const ratingRaw =
								(ratingInputEl && ratingInputEl.value && ratingInputEl.value.trim()) || '0';
						const rating = parseFloat(ratingRaw);

						// ë‚´ìš© ë¬¸ìì—´ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
						const content =
								(contentTextarea && contentTextarea.value
												? contentTextarea.value
												: ''
								).trim();

						const errors = [];

						// 1) ë³„ì  í•„ìˆ˜ (0.5 ~ 5.0)
						if (isNaN(rating) || rating <= 0) {
							errors.push('ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
						} else if (rating < 0.5 || rating > 5.0) {
							errors.push('ë³„ì ì€ 0.5ì  ì´ìƒ 5.0ì  ì´í•˜ì…ë‹ˆë‹¤.');
						}

						// 2) ë‚´ìš© ê¸¸ì´ ì²´í¬ (ìµœì†Œ 3ì, ìµœëŒ€ 300ì)
						if (content.length < 3) {
							errors.push('ë¦¬ë·° ë‚´ìš©ì€ ìµœì†Œ 3ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
						}
						if (content.length > 300) {
							errors.push('ë¦¬ë·° ë‚´ìš©ì€ 300ì ì´ë‚´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
						}

						// ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì „ì†¡ ë§‰ê³  ì•Œë¦¼
						if (errors.length > 0) {
							e.preventDefault();
							alert(errors.join('\n'));
						}
					});
				}
			});
		</script>
	</th:block>

<div layout:fragment="content" class="bg-gray-50 min-h-screen">

    <div class="flex max-w-6xl mx-auto py-10 mt-20">

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="w-60 bg-white shadow-md rounded-lg p-6 mr-8">
            <h2 class="text-xl font-bold mb-6">ë§ˆì´í˜ì´ì§€</h2>

            <nav class="flex flex-col space-y-3">
                <a href="/mypage/profile" class="px-3 py-2 rounded-md hover:bg-gradient2 hover:text-white">í”„ë¡œí•„ í™•ì¸</a>
                <a href="/mypage/account" class="px-3 py-2 rounded-md hover:bg-gradient2 hover:text-white">íšŒì›ìˆ˜ì • ë° íšŒì›íƒˆí‡´</a>
                <a href="/mypage/favorites" class="px-3 py-2 rounded-md hover:bg-gradient2 hover:text-white">ì¶•ì œ ì¦ê²¨ì°¾ê¸°</a>
                <a href="/mypage/reviews" class="px-3 py-2 rounded-md bg-gray-200 hover:bg-gradient2 hover:text-white">ë‚´ ë¦¬ë·° ê´€ë¦¬</a>
            </nav>
        </aside>

        <!-- ë³¸ë¬¸ -->
        <main class="flex-1">
            <div class="bg-white shadow-md rounded-2xl p-10">
                <h2 class="text-h1 font-black text-gradient mb-3">ë¦¬ë·° ìˆ˜ì •</h2>

                <div class="h-px bg-gray-300 my-2 mb-10"></div>

                <form action="/mypage/reviews/update" method="post" class="space-y-8" data-review-form="true">

                    <!-- ë¦¬ë·° ë²ˆí˜¸ -->
                    <input type="hidden" name="reviewNo" th:value="${review.reviewNo}">

                    <!-- ì¶•ì œëª… -->
                    <div>
                        <label class="block font-bold mb-2">ì¶•ì œëª…</label>
                        <input type="text" th:value="${review.festival.title}" disabled
                               class="w-full border rounded-md p-3 bg-gray-100">
                    </div>

                    <!-- ë³„ì  ì…ë ¥ -->
                    <div>
                        <label class="block font-bold mb-2">ë³„ì </label>

                        <div id="ratingBox" class="star-rating star-rating--input">
                            <span class="star" data-index="1"></span>
                            <span class="star" data-index="2"></span>
                            <span class="star" data-index="3"></span>
                            <span class="star" data-index="4"></span>
                            <span class="star" data-index="5"></span>
                        </div>

                        <span id="ratingValueText" class="text-subtext ml-2"></span>

                        <!-- ì‹¤ì œ ê°’ -->
                        <input type="hidden" id="ratingInput" name="rating" th:value="${review.rating}">
                    </div>

                    <!-- ë‚´ìš© -->
                    <div>
                        <label class="block font-bold mb-2">ë¦¬ë·° ë‚´ìš©</label>
                        <textarea name="content" th:text="${review.content}"
                                  class="w-full border rounded-md p-3 h-40 resize-none focus:ring-main focus:border-main"></textarea>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <div>
                        <button type="submit"
                                class="bg-gradient-to-br from-[#6B96FC] to-[#4A80FA] text-white px-6 py-3 rounded-md shadow">
                            ìˆ˜ì • ì™„ë£Œ
                        </button>
                    </div>

                </form>

            </div>

        </main>

    </div>

</div>

</html>
