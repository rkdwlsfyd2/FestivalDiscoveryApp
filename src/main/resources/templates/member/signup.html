<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{common/mylayout}">
<body>

<div layout:fragment="content" class="relative z-50">

    <div class="flex justify-center items-center mt-20 mb-20">
        <div class="w-full max-w-2xl bg-white shadow-md border border-gray-300 rounded-xl p-8">

            <h2 class="font-black text-center text-h1 text-gradient mb-6">회원가입</h2>

            <!-- 서버단 오류 표시 -->
            <div th:if="${error}"
                 class="bg-red-100 text-red-700 p-2 rounded mb-4">
                <p th:text="${error}"></p>
            </div>

            <!-- DTO 바인딩 추가 -->
            <form id="signupForm" th:object="${memberDto}" action="/signup" method="post" class="space-y-4">

                <!-- 이메일 인증 코드 -->
                <input type="hidden" th:field="*{emailCode}" id="hiddenEmailCode">

                <!-- 아이디 -->
                <div>
                    <label class="block text-gray-700 mb-1">아이디</label>
                    <div class="flex gap-2">
                        <input th:field="*{userId}" id="userId"
                               class="w-full border px-3 py-2 rounded" required>
                        <button type="button" id="checkIdBtn"
                                class="bg-main text-white px-3 py-2 rounded whitespace-nowrap">
                            중복 확인
                        </button>
                    </div>
                    <p id="idCheckMsg" class="text-sm mt-1"></p>
                </div>

                <!-- 비밀번호 -->
                <div>
                    <label class="block text-gray-700 mb-1">비밀번호</label>
                    <input type="password" th:field="*{password}" id="password"
                           class="w-full border px-3 py-2 rounded" required>
                    <p class="text-sm text-gray-500 mt-1">
                        * 8~20자 / 영문 + 숫자 또는 특수문자 포함
                    </p>
                </div>

                <!-- 비밀번호 확인 -->
                <div>
                    <label class="block text-gray-700 mb-1">비밀번호 확인</label>
                    <input type="password" id="passwordConfirm"
                           class="w-full border px-3 py-2 rounded" required>
                    <p id="pwCheckMsg" class="text-sm mt-1"></p>
                </div>

                <!-- 이메일 -->
                <div>
                    <label class="block text-gray-700 mb-1">이메일</label>
                    <div class="flex gap-2">
                        <input th:field="*{email}" id="email"
                               class="w-full border px-3 py-2 rounded" required>
                        <button type="button" id="checkEmailBtn"
                                class="bg-main text-white px-3 py-2 rounded whitespace-nowrap">
                            중복 확인
                        </button>
                    </div>
                    <p id="emailMsg" class="text-sm mt-1"></p>

                    <button type="button" id="emailSendBtn"
                            class="bg-gray-400 text-white px-4 py-2 rounded mt-2"
                            disabled>
                        인증 코드 발송
                    </button>
                </div>

                <!-- 인증 코드 입력 -->
                <div>
                    <label class="block text-gray-700 mb-1">인증 코드</label>
                    <input type="text" id="emailCodeInput"
                           class="w-full border px-3 py-2 rounded">
                </div>

                <button type="button" id="verifyEmailBtn"
                        class="bg-main text-white px-4 py-2 rounded mt-2">
                    인증번호 확인
                </button>

                <p id="verifyMsg" class="text-sm mt-1"></p>


                <!-- 이름 -->
                <div>
                    <label class="block text-gray-700 mb-1">이름</label>
                    <input th:field="*{name}"
                           class="w-full border px-3 py-2 rounded" required>
                </div>

                <!-- 전화번호: 010 고정 + 8자리 -->
                <div>
                    <label class="block text-gray-700 mb-1">전화번호</label>

                    <div class="flex gap-2 items-center">
                        <span class="px-3 py-2 border rounded bg-gray-100">
                            010-
                        </span>

                        <input id="phoneRest"
                               type="text"
                               maxlength="8"
                               class="w-full border px-3 py-2 rounded"
                               placeholder="8자리 입력"
                        >
                    </div>

                    <p id="phoneMsg" class="text-sm mt-1"></p>

                    <!-- 최종 저장용 hidden input -->
                    <input type="hidden" th:field="*{phone}" id="phoneFull">
                </div>


                <!-- 성별 -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1">성별</label>

                    <div class="relative">
                        <button type="button" id="genderDropdownBtn"
                                class="w-full flex items-center justify-between px-4 py-2 bg-white text-black border border-gray-300 rounded-lg cursor-pointer">
                            <span id="genderSelectedText">선택 없음</span>
                            <svg id="genderDropdownIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="genderDropdownMenu"
                             class="hidden absolute w-full mt-1 bg-white border border-gray-300 rounded shadow max-h-60 overflow-y-auto z-50">

                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white"
                                 data-value="">
                                선택 없음
                            </div>

                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white"
                                 data-value="M">
                                남성
                            </div>

                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white"
                                 data-value="F">
                                여성
                            </div>
                        </div>
                    </div>

                    <!-- 숨겨진 셀렉트 태그 (Spring Form 연동) -->
                    <select th:field="*{gender}" id="genderSelect" class="hidden">
                        <option value="">선택 없음</option>
                        <option value="M">남성</option>
                        <option value="F">여성</option>
                    </select>
                </div>

                <!-- 생년월일 -->
                <div>
                    <label class="block text-gray-700 mb-1">생년월일</label>
                    <input type="date" th:field="*{birthDate}" id="birthDate"
                           class="w-full border px-3 py-2 rounded" required>
                </div>

                <!-- 선호 태그 -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-1">선호 태그</label>

                    <div class="relative">
                        <button type="button" id="tagDropdownBtn"
                                class="w-full flex items-center justify-between px-4 py-2 bg-white text-black border border-gray-300 rounded-lg cursor-pointer">
                            <span id="tagSelectedText">선택하세요</span>
                            <svg id="tagDropdownIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="tagDropdownMenu"
                             class="hidden absolute w-full mt-1 bg-white border border-gray-300 rounded shadow max-h-60 overflow-y-auto z-50">

                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white"
                                 data-value="">
                                선택하세요
                            </div>

                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="자연">자연</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="야간">야간</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="먹거리">먹거리</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="체험">체험</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="계절">계절</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="문화">문화</div>
                            <div class="dropdown-option px-4 py-2 cursor-pointer hover:bg-main hover:text-white" data-value="아동">아동</div>
                        </div>
                    </div>

                    <!-- 숨겨진 select (Spring Form 연동) -->
                    <select th:field="*{favoriteTag}" id="tagSelect" class="hidden" required>
                        <option value="">-- 선택하세요 --</option>
                        <option value="자연">자연</option>
                        <option value="야간">야간</option>
                        <option value="먹거리">먹거리</option>
                        <option value="체험">체험</option>
                        <option value="계절">계절</option>
                        <option value="문화">문화</option>
                        <option value="아동">아동</option>
                    </select>
                </div>

                <button type="submit"
                        class="w-full bg-main text-white text-xl py-2 rounded font-bold hover:bg-gradient2 font-bold
                        duration-300 ease-in-out hover:scale-95">
                    회원가입 완료
                </button>

            </form>

        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script type="text/javascript" th:src="@{/js/signupDropdown.js}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            let emailVerified = false;

            /* ------------------- 비밀번호 체크 ------------------- */
            const password = document.getElementById("password");
            const passwordConfirm = document.getElementById("passwordConfirm");
            const pwCheckMsg = document.getElementById("pwCheckMsg");

            function checkPwMatch() {

                const pw = password.value;
                const pwc = passwordConfirm.value;

                // ⭐ 비밀번호 정규식: 영문 + 숫자 또는 특수문자, 8~20자
                const pwPattern =
                    /^(?=.*[A-Za-z])(?=.*(\d|[!@#$%^&*?_~]))[A-Za-z\d!@#$%^&*?_~]{8,20}$/;

                // 둘 다 비었으면 리셋
                if (pw === "" && pwc === "") {
                    pwCheckMsg.innerText = "";
                    return;
                }

                // ⭐ 먼저 형식 검증
                if (!pwPattern.test(pw)) {
                    pwCheckMsg.innerText = "비밀번호 형식이 올바르지 않습니다. (영문 + 숫자/특수기호, 8~20자)";
                    pwCheckMsg.style.color = "red";
                    return;
                }

                // ⭐ 정규식 통과 → 이제 일치 여부 검사
                if (pw !== "" && pwc !== "") {
                    if (pw === pwc) {
                        pwCheckMsg.innerText = "비밀번호가 일치합니다.";
                        pwCheckMsg.style.color = "green";
                    } else {
                        pwCheckMsg.innerText = "비밀번호가 일치하지 않습니다.";
                        pwCheckMsg.style.color = "red";
                    }
                } else {
                    pwCheckMsg.innerText = "";
                }
            }

            password.addEventListener("input", checkPwMatch);
            passwordConfirm.addEventListener("input", checkPwMatch);


            /* ------------------- 아이디 중복확인 ------------------- */
            const userId = document.getElementById("userId");
            const idCheckMsg = document.getElementById("idCheckMsg");
            const checkIdBtn = document.getElementById("checkIdBtn");

            checkIdBtn.addEventListener("click", () => {
                const uid = userId.value.trim();
                const idRegex = /^[a-zA-Z0-9]{5,20}$/;

                if (!idRegex.test(uid)) {
                    idCheckMsg.innerText = "영문/숫자 5~20자 입력";
                    idCheckMsg.style.color = "red";
                    return;
                }

                fetch(`/api/member/check-userid?userId=${uid}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.exists) {
                            idCheckMsg.innerText = "이미 사용 중인 아이디입니다.";
                            idCheckMsg.style.color = "red";
                        } else {
                            idCheckMsg.innerText = "사용 가능한 아이디입니다!";
                            idCheckMsg.style.color = "green";
                        }
                    });
            });


            /* ------------------- 이메일 중복확인 ------------------- */
            const emailInput = document.getElementById("email");
            const checkEmailBtn = document.getElementById("checkEmailBtn");
            const emailMsgTag = document.getElementById("emailMsg");
            const emailSendBtn = document.getElementById("emailSendBtn");
            const emailPattern = /^[0-9a-zA-Z._%+-]+@[0-9a-zA-Z.-]+\.[a-zA-Z]{2,}$/;

            checkEmailBtn.addEventListener("click", () => {
                const email = emailInput.value.trim();

                if (!emailPattern.test(email)) {
                    emailMsgTag.innerText = "올바른 이메일 형식이 아닙니다.";
                    emailMsgTag.style.color = "red";
                    emailSendBtn.disabled = true;
                    emailSendBtn.classList.remove("bg-main");
                    emailSendBtn.classList.add("bg-gray-400");
                    return;
                }

                fetch(`/api/member/check-email?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.exists) {
                            emailMsgTag.innerText = "이미 가입된 이메일입니다.";
                            emailMsgTag.style.color = "red";
                            emailSendBtn.disabled = true;
                        } else {
                            emailMsgTag.innerText = "사용 가능한 이메일입니다!";
                            emailMsgTag.style.color = "green";
                            emailSendBtn.disabled = false;
                            emailSendBtn.classList.remove("bg-gray-400");
                            emailSendBtn.classList.add("bg-main");
                        }
                    });
            });


            /* ------------------- 인증코드 발송 ------------------- */
            const emailCodeInput = document.getElementById("emailCodeInput");
            const hiddenEmailCode = document.getElementById("hiddenEmailCode");
            const verifyEmailBtn = document.getElementById("verifyEmailBtn");
            const verifyMsg = document.getElementById("verifyMsg");

            emailSendBtn.addEventListener("click", () => {
                const email = emailInput.value.trim();

                fetch(`/api/member/send-email-code?email=${email}`)
                    .then(res => res.text())
                    .then(result => {
                        if (result === "OK") {
                            alert("인증코드가 이메일로 발송되었습니다!");
                        }
                    });
            });


            /* ------------------- 인증번호 확인 ------------------- */
            verifyEmailBtn.addEventListener("click", () => {
                const email = emailInput.value.trim();
                const code = emailCodeInput.value.trim();

                fetch(`/api/member/verify-email-code`, {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: `email=${email}&code=${code}`
                })
                    .then(res => res.text())
                    .then(result => {
                        if (result === "true" || result === true) {
                            verifyMsg.innerText = "인증 완료!";
                            verifyMsg.style.color = "green";
                            hiddenEmailCode.value = code;
                            emailVerified = true;
                        } else {
                            verifyMsg.innerText = "인증번호가 잘못되었습니다.";
                            verifyMsg.style.color = "red";
                        }
                    });
            });


            /* ------------------- 전화번호: 010 고정 + 8자리 입력 ------------------- */
            const phoneRest = document.getElementById("phoneRest");
            const phoneFull = document.getElementById("phoneFull");
            const phoneMsg = document.getElementById("phoneMsg");

            phoneRest.addEventListener("input", () => {

                let v = phoneRest.value.replace(/[^0-9]/g, "");
                if (v.length > 8) v = v.slice(0, 8);

                phoneRest.value = v;

                if (v.length === 8) {
                    const formatted = `010${v.slice(0,4)}${v.slice(4,8)}`;
                    phoneFull.value = formatted;

                    phoneMsg.innerText = "올바른 전화번호입니다.";
                    phoneMsg.style.color = "green";
                } else {
                    phoneFull.value = "";
                    phoneMsg.innerText = "숫자 8자리를 입력해주세요.";
                    phoneMsg.style.color = "red";
                }
            });


            /* ------------------- 생년월일: 오늘 이후 선택 불가 ------------------- */
            const birthInput = document.getElementById("birthDate");
            if (birthInput) {
                const today = new Date().toISOString().split("T")[0];
                birthInput.setAttribute("max", today);
            }


            /* ------------------- 최종 가입 검증 ------------------- */
            const signupForm = document.getElementById("signupForm");

            signupForm.addEventListener("submit", (e) => {

                if (!emailVerified) {
                    e.preventDefault();
                    alert("이메일 인증을 완료해주세요!");
                    return;
                }

                if (!phoneFull.value) {
                    e.preventDefault();
                    alert("전화번호를 올바르게 입력해주세요!");
                    return;
                }
            });

        });
    </script>
</th:block>

</body>
</html>
