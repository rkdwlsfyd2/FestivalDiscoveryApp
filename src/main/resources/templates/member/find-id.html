<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}"
      lang="ko">

<section layout:fragment="content" class="relative z-50">
    <div class="flex justify-center items-center mt-20">

        <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-8">

            <h2 class="text-center text-h3 font-bold text-main mb-6">ì•„ì´ë”” ì°¾ê¸°</h2>

            <!-- ì´ë©”ì¼ ì…ë ¥ -->
            <div>
                <label class="block text-gray-700 mb-1">ì´ë©”ì¼</label>
                <input type="email" id="email"
                       class="w-full border rounded px-3 py-2 mb-2">
                <p id="emailMsg" class="text-sm"></p>

                <button type="button" id="sendCodeBtn"
                        class="w-full bg-main text-white py-2 rounded mb-3">
                    ì¸ì¦ì½”ë“œ ë°œì†¡
                </button>
            </div>

            <!-- ì¸ì¦ì½”ë“œ ì…ë ¥ -->
            <div>
                <label class="block text-gray-700 mb-1">ì¸ì¦ì½”ë“œ</label>
                <input type="text" id="verifyCode"
                       class="w-full border rounded px-3 py-2 mb-3">
            </div>

            <button type="button" id="findIdBtn"
                    class="w-full bg-main text-white py-2 rounded">
                ì•„ì´ë”” ì°¾ê¸°
            </button>

            <p id="resultMsg" class="mt-4 text-center text-lg font-bold"></p>

        </div>
    </div>
</section>

<th:block layout:fragment="script">
    <script>
        let verified = false;

        const email = document.getElementById("email");
        const emailMsg = document.getElementById("emailMsg");
        const verifyCode = document.getElementById("verifyCode");
        const sendCodeBtn = document.getElementById("sendCodeBtn");
        const findIdBtn = document.getElementById("findIdBtn");
        const resultMsg = document.getElementById("resultMsg");

        /* ----------------------------------------------------
       ğŸ“Œ ì´ë©”ì¼ ì…ë ¥ ì¤‘ì—ëŠ” ë©”ì‹œì§€ ì´ˆê¸°í™”
        ---------------------------------------------------- */
        email.addEventListener("input", () => {
            emailMsg.innerText = "";
            verified = false;
        });
        /* ----------------------------------------------------
           ğŸ“Œ 1) ì¸ì¦ì½”ë“œ ë°œì†¡ (ê°€ì…ëœ ì´ë©”ì¼ë§Œ ê°€ëŠ¥í•˜ê²Œ)
        ---------------------------------------------------- */
        sendCodeBtn.addEventListener("click", () => {
            const emailValue = email.value.trim();

            if (emailValue === "") {
                emailMsg.innerText = "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.";
                emailMsg.style.color = "red";
                return;
            }

            fetch(`/api/member/send-email-code?email=${emailValue}&type=findId`)
                .then(res => res.text())
                .then(result => {

                    if (result === "EMPTY") {
                        emailMsg.innerText = "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.";
                        emailMsg.style.color = "red";
                        return;
                    }

                    if (result === "NOT_FOUND") {
                        emailMsg.innerText = "ê°€ì…ëœ ì´ë©”ì¼ì´ ì•„ë‹™ë‹ˆë‹¤.";
                        emailMsg.style.color = "red";
                        return;
                    }

                    if (result === "OK") {
                        emailMsg.innerText = "ì¸ì¦ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
                        emailMsg.style.color = "green";
                        alert("ì¸ì¦ì½”ë“œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                });
        });

        /* ----------------------------------------------------
           ğŸ“Œ 2) ì¸ì¦ì½”ë“œ ê²€ì¦
        ---------------------------------------------------- */
        verifyCode.addEventListener("input", () => {
            const emailValue = email.value.trim();
            const code = verifyCode.value.trim();

            if (code === "") return;

            fetch(`/api/member/verify-email-code`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `email=${emailValue}&code=${code}`
            })
                .then(res => res.text())
                .then(result => {
                    if (result === "true") {
                        emailMsg.innerText = "ì´ë©”ì¼ ì¸ì¦ ì„±ê³µ!";
                        emailMsg.style.color = "green";
                        verified = true;
                    } else {
                        emailMsg.innerText = "ì¸ì¦ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                        emailMsg.style.color = "red";
                        verified = false;
                    }
                });
        });

        /* ----------------------------------------------------
           ğŸ“Œ 3) ì•„ì´ë”” ì°¾ê¸°
        ---------------------------------------------------- */
        findIdBtn.addEventListener("click", () => {

            if (!verified) {
                alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•˜ì„¸ìš”.");
                return;
            }

            const emailValue = email.value.trim();

            fetch(`/api/member/find-id?email=${emailValue}`)
                .then(res => res.text())
                .then(userId => {
                    if (userId === "NOT_FOUND") {
                        resultMsg.innerText = "ê°€ì…ëœ ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤.";
                        resultMsg.style.color = "red";
                    } else {
                        resultMsg.innerText = `ë‹¹ì‹ ì˜ ì•„ì´ë””: ${userId}`;
                        resultMsg.style.color = "green";
                    }
                });
        });

    </script>
</th:block>

</html>
