<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<th:block layout:fragment="css">
    <style>
        #kakaoMap {
            width: 100%;
            height: 650px;
            min-height: 650px;
        }
        #kakaoMap *,
        #kakaoMap canvas {
            box-shadow: none !important;
            filter: drop-shadow(none) !important;
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div class="container mx-auto px-6 pt-8 pb-8 mt-20">
        <div class="bg-[#E6E8F2] rounded-lg shadow-md border border-gray-300
				flex flex-col lg:flex-row gap-6 w-full max-w-[1300px] mx-auto items-start p-4">

            <!-- 왼쪽: 축제 목록 -->
            <div class="w-full lg:w-1/3" id="festivalListWrapper">
                <h1 class="text-h1 font-black text-gradient mb-4">축제 목록</h1>

                <!-- 검색창 및 태그 필터 -->
                <div th:replace="~{review/filterui :: filterUI}"></div>

                <!-- 축제 목록 카드들 -->
                <div th:replace="~{review/festivalList :: festivalList}"></div>
            </div>

            <!-- 오른쪽: 카카오 지도 -->
            <div class="w-full lg:w-2/3" id="mapWrapper">
                <h2 class="text-h1 font-bold text-main mb-4 invisible">축제 목록</h2>
                <div class="w-full rounded-lg overflow-hidden flex-1">
                    <div th:replace="~{review/kakaomap :: mapContent}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">

    <script th:inline="javascript">
        // 로그인 되어 있으면 true, 아니면 false
        window.fdIsLoggedIn = /*[[${loginUser != null}]]*/ false;
    </script>
    <!-- 카카오맵 스크립트 및 마커 로직 -->
    <th:block th:replace="~{review/kakaomap :: mapScript}"></th:block>

    <!-- 기존 JS (리스트 AJAX, 필터 핸들러) -->
    <script type="text/javascript" th:src="@{/js/festivalDataLoad.js}"></script>
    <script type="text/javascript" th:src="@{/js/filterhandler.js}"></script>

    <!-- 전체 지도 높이 맞추기 + AJAX 이후 마커 갱신 -->
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            function adjustMapHeight() {
                if (window.innerWidth >= 1024) {
                    const festivalListWrapper = document.querySelector("#festivalListWrapper");
                    const mapWrapper = document.querySelector("#mapWrapper");
                    const kakaoMap = document.querySelector("#kakaoMap");

                    if (festivalListWrapper && mapWrapper && kakaoMap) {
                        const festivalHeight = festivalListWrapper.offsetHeight;
                        mapWrapper.style.height = festivalHeight + "px";
                        kakaoMap.style.height = "100%";
                    }
                }
            }

            // 초기 진입 시 한번 맞추기
            adjustMapHeight();

            window.addEventListener("resize", adjustMapHeight);

            // 기존 updateFestivalList 감싸서, AJAX 이후에 높이 + 마커 다시 세팅
            const originalUpdateFestivalList = window.updateFestivalList;
            if (typeof originalUpdateFestivalList === "function") {
                window.updateFestivalList = function (...args) {
                    const result = originalUpdateFestivalList.apply(this, args);

                    setTimeout(function () {
                        adjustMapHeight();
                        if (typeof window.updateKakaoMarkersFromDom === "function") {
                            window.updateKakaoMarkersFromDom({ keepBounds: true });
                        }
                    }, 100);

                    return result;
                };
            } else {
                // 혹시 모를 초기 동기화를 위해 한번 호출
                if (typeof window.updateKakaoMarkersFromDom === "function") {
                    window.updateKakaoMarkersFromDom({ keepBounds: true });
                }
            }
        });
    </script>
</th:block>

</html>

