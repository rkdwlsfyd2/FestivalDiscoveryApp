<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<th:block layout:fragment="css">
    <style>
        #naverMap {
            width: 100%;
            height: 600px;
            min-height: 600px;
        }
        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            #naverMap {
                height: 500px;
                min-height: 500px;
            }
        }
        /* 전체 페이지 스크롤 개선 */
        html {
            overflow-x: hidden;
            overflow-y: auto;
        }
        body {
            overflow-x: hidden;
            overflow-y: auto;
        }
        /* 컨테이너 스크롤 개선 */
        .container {
            overflow-x: hidden;
        }
        
        /* 로딩 스피너 스타일 */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A80FA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 450px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }
        
        .loading-text {
            margin-top: 16px;
            color: #4A80FA;
            font-weight: 500;
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div class="container mx-auto px-4 py-8 mb-16 min-h-screen">
        <!-- <h1 class="text-h1 font-bold text-main mb-6">축제 정보 맵</h1> -->

        <!-- 왼쪽 축제 목록, 오른쪽 지도 레이아웃 -->
        <div class="bg-[#E6E8F2] rounded-lg shadow-lg 
                flex flex-col lg:flex-row gap-6 w-full max-w-7xl mx-auto items-start p-4">

            <!-- 왼쪽: 축제 목록 -->
            <div class="w-full lg:w-1/3" id="festivalListWrapper">
                <div th:replace="review/festivalList :: festivalList"></div>
            </div>

            <!-- 오른쪽: 네이버 지도 -->
            <div class="w-full lg:w-2/3">
                <h2 class="text-h3 font-bold text-main mb-4 invisible">축제 목록</h2>
                <div class="w-full rounded-lg overflow-hidden shadow-lg">
                    <div th:replace="~{review/navermap::mapContent}"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<th:block layout:fragment="script">
    <th:block th:replace="~{review/navermap::mapScript}"></th:block>

    <script type="text/javascript">

        // 로딩 표시 HTML 생성
        function createLoadingHTML(searchValue = "") {
            // 특수 문자 이스케이프 처리
            const escapedValue = searchValue.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            return `
                <div class="w-full h-full">
                    <h1 class="text-h3 font-bold text-main mb-4">축제 목록</h1>
                    <div class="mb-4">
                        <div class="flex gap-3">
                            <input 
                                type="text"
                                id="keywordInput"
                                placeholder="축제명을 검색하세요..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-main focus:border-transparent"
                                value="${escapedValue}">
                            <button 
                                type="button" 
                                id="searchBtn"
                                class="px-4 py-2 bg-sub-red text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-1 whitespace-nowrap">
                                <i class="fas fa-search"></i>
                                <span>검색</span>
                            </button>
                        </div>
                    </div>
                    <div id="festivalListContainer" class="mb-8 overflow-y-auto overflow-x-hidden" style="height: 450px; max-height: 450px; box-sizing: border-box;">
                        <div class="loading-overlay">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">축제 목록을 불러오는 중...</div>
                        </div>
                    </div>
                    <div id="pagination" class="flex justify-center items-center gap-2 mt-16"></div>
                </div>
            `;
        }

        // AJAX로 축제 목록 업데이트하는 공통 함수
        function updateFestivalList(page = 0, keyword = "") {
            const keywordInput = document.querySelector("#keywordInput");
            const searchKeyword = keyword || (keywordInput?.value || "");
            const wrapper = document.getElementById('festivalListWrapper');
            
            // 로딩 표시 (검색어 값 유지)
            if (wrapper) {
                wrapper.innerHTML = createLoadingHTML(searchKeyword);
            }
            
            // AJAX 요청
            fetch(`/festivals/review/ajax?page=${page}&size=5&keyword=${encodeURIComponent(searchKeyword)}`)
                .then(res => res.text())
                .then(html => {
                    // 데이터 로드 완료 후 0.5초 지연
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            resolve(html);
                        }, 500);
                    });
                })
                .then(html => {
                    if (wrapper) {
                        wrapper.innerHTML = html;
                        // 스크롤을 맨 위로 이동
                        const container = document.getElementById('festivalListContainer');
                        if (container) {
                            container.scrollTop = 0;
                        }
                    }
                });
        }

        // 페이징 처리 시, 전체 페이지를 리로드하지 않고 AJAX로 축제 목록만 업데이트
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("page-btn")) {
                e.preventDefault();
                let page = e.target.dataset.page;
                updateFestivalList(page);
            }
            
            // 검색 버튼 클릭 시
            if (e.target.id === "searchBtn" || e.target.closest("#searchBtn")) {
                e.preventDefault();
                updateFestivalList(0); // 검색 시 첫 페이지로 이동
            }
        });

        // 검색창에서 Enter 키 입력 시 검색
        document.addEventListener("DOMContentLoaded", function() {
            const keywordInput = document.querySelector("#keywordInput");
            if (keywordInput) {
                keywordInput.addEventListener("keypress", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        updateFestivalList(0); // 검색 시 첫 페이지로 이동
                    }
                });
            }
        });
    </script>
</th:block>






