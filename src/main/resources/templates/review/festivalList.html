<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ï∂ïÏ†ú Î™©Î°ù</title>
</head>
<style>
            .fd-fav-form button {
            pointer-events: auto;
        }

        .festival-card .fd-fav-form {
            pointer-events: auto;
        }

        .festival-card {
            pointer-events: auto;
        }

</style>
<body>
    <!-- Ï∂ïÏ†ú Î™©Î°ù ÌëúÏãú ÏòÅÏó≠ (Thymeleaf fragment) -->
    <div th:fragment="festivalList" id="festivalListRoot">
        <div class="w-full h-full">

            <!-- 1. Î°úÍ∑∏Ïù∏ ÏïàÎÇ¥ Î∞∞ÎÑà -->
            <div th:if="${loginUser == null}"
                 class="mb-3 px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-xs text-gray-700 flex items-center gap-2">
                <span>üîë</span>
                <span>
                    Î°úÍ∑∏Ïù∏ÌïòÏãúÎ©¥ <strong>Ï¶êÍ≤®Ï∞æÍ∏∞</strong>ÏôÄ
                    <strong>AI Ï∂îÏ≤ú</strong> Í∏∞Îä•ÏùÑ Ïù¥Ïö©ÌïòÏã§ Ïàò ÏûàÏñ¥Ïöî.
                </span>
				<a th:with="redirectUrl=@{/festivals/festivalMap(page=${festivalList.number},
																 size=${festivalList.size},
																 keyword=${keyword},
																 ongoingOnly=${ongoingOnly},
																 region=${region},
																 tag=${tag})}"
				   th:href="@{/login(redirectUrl=${redirectUrl})}"
				   class="ml-auto text-[11px] text-blue-600 hover:underline">
                    Î°úÍ∑∏Ïù∏
                </a>
            </div>

            <!-- 2. Ï∂ïÏ†ú Î™©Î°ù Ïä§ÌÅ¨Î°§ ÏòÅÏó≠ -->
            <div id="festivalListContainer"
                 class="mb-8 overflow-y-auto overflow-x-hidden"
                 style="height: 450px; max-height: 500px; box-sizing: border-box;">
                <div class="festival-items space-y-4 pr-2">

                    <!-- 2-1. Îç∞Ïù¥ÌÑ∞ ÏóÜÏùÑ Îïå -->
                    <div th:if="${festivalList == null or festivalList.isEmpty()}"
                         class="text-center text-gray-500 py-8">
                        <p>Îì±Î°ùÎêú Ï∂ïÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>

                    <!-- 2-2. Ï∂ïÏ†ú Ïπ¥ÎìúÎì§ -->
                    <div th:each="festival : ${festivalList.content}"
                         class="festival-card bg-white rounded-lg p-4 cursor-pointer border-2 border-sub-red"
                         th:data-festival-no="${festival.festivalNo}"
                         th:data-lat="${festival.mapy}"
                         th:data-lng="${festival.mapx}"
                         th:data-title="${festival.title}"
                         th:data-addr="${festival.addr}"
                         th:data-start="${festival.eventStartDate != null ? #temporals.format(festival.eventStartDate, 'yyyy.MM.dd') : ''}"
                         th:data-end="${festival.eventEndDate != null ? #temporals.format(festival.eventEndDate, 'yyyy.MM.dd') : ''}"
                         th:onmouseover="|window.fdHighlightMarkerByFestivalNo('${festival.festivalNo}')|"
                         th:onmouseout="|window.fdUnhighlightMarkerByFestivalNo('${festival.festivalNo}')|"
                         th:onclick="|window.fdOpenOverlayByFestivalNo('${festival.festivalNo}')|">

                        <!-- 2-2-1. AI ÏïÑÏù¥ÏΩò + Ï∂ïÏ†ú Ïù¥ÎØ∏ÏßÄ -->
                        <div th:if="${festival.images != null and !#lists.isEmpty(festival.images)}" class="relative mb-3">
                            <img th:src="${festival.images[0].imageUrl}"
                                 class="w-full h-36 object-cover rounded-lg mb-3" />
							<span th:if="${aiFestivalNos != null and #sets.contains(aiFestivalNos, festival.festivalNo)}"
								  class="absolute left-2 top-2 inline-flex items-center px-2 py-0.5 rounded-full bg-gradient2 text-foreground text-[11px] font-semibold shadow pointer-events-none">
                                    <span>AI Ï∂îÏ≤ú</span>
							</span>
                        </div>

                        <!-- Ïù¥ÎØ∏ÏßÄ ÏóÜÏùÑ Îïå -->
                        <div th:if="${festival.images == null or #lists.isEmpty(festival.images)}"
                             class="relative w-full h-36 bg-gray-300 rounded-lg mb-3 flex items-center justify-center">
                            <span class="text-xs text-gray-600">Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</span>
							<span th:if="${aiFestivalNos != null and #sets.contains(aiFestivalNos, festival.festivalNo)}"
								  class="absolute left-2 top-2 inline-flex items-center px-2 py-0.5 rounded-full bg-gradient2 text-foreground text-[11px] font-semibold shadow pointer-events-none">
                                    <span>AI Ï∂îÏ≤ú</span>
							</span>
                        </div>

                        <!-- 2-2-2. Ï†úÎ™© + ÌÉúÍ∑∏ ÏïÑÏù¥ÏΩò + Ï¶êÍ≤®Ï∞æÍ∏∞ Ìïú Ï§Ñ -->
                        <div class="mb-2 flex items-center gap-2 flex-wrap">

                            <!-- Ï†úÎ™© -->
                            <h3 class="text-lg font-suit font-bold text-gray-800"
                                th:text="${festival.title}">Ï∂ïÏ†ú Ï†úÎ™©</h3>

                            <!-- ÌÉúÍ∑∏ ÏïÑÏù¥ÏΩò -->
                            <div class="flex flex-wrap gap-1"
                                 th:if="${tagMap != null and tagMap[festival.festivalNo] != null}">

                                <!-- ÌÉúÍ∑∏ ÏïÑÏù¥ÏΩò -->
                                <span th:each="tag : ${tagMap[festival.festivalNo]}"
                                      class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 border">
                                    <span th:switch="${tag.tag}">
                                        <span th:case="'ÏûêÏó∞'">üåø</span>
                                        <span th:case="'ÏïºÍ∞Ñ'">üåô</span>
                                        <span th:case="'Î®πÍ±∞Î¶¨'">üçú</span>
                                        <span th:case="'Ï≤¥Ìóò'">üé®</span>
                                        <span th:case="'Í≥ÑÏ†à'">‚ùÑÔ∏è</span>
                                        <span th:case="'Î¨∏Ìôî'">üé≠</span>
                                        <span th:case="'ÏïÑÎèô'">üë¶</span>
                                    </span>
                                </span>
                            </div>

                            <!-- Ï¶êÍ≤®Ï∞æÍ∏∞ Î≤ÑÌäº -->
                            <form method="post"
                                  th:action="@{/favorite/toggle}"
                                  th:id="'fav-form-' + ${festival.festivalNo}"
                                  class="fd-fav-form">

                                <input type="hidden" name="festivalNo"
                                       th:value="${festival.festivalNo}">

                                <!-- Î°úÍ∑∏Ïù∏ ÌõÑ ÎèåÏïÑÏò¨ redirectUrl -->
                                <input type="hidden" name="redirectUrl"
                                       th:value="@{/festivals/festivalMap(page=${festivalList.number},
                                                                          size=${festivalList.size},
                                                                          keyword=${keyword},
                                                                          ongoingOnly=${ongoingOnly},
                                                                          region=${region},
                                                                          tag=${tag})}">

                                <button type="submit"
                                        onclick="event.stopPropagation(); event.preventDefault(); this.closest('form').submit();"
                                        class="text-[12px] px-3 py-1 rounded-lg border font-semibold"
                                        th:classappend="${favoriteFestivalNos != null and #sets.contains(favoriteFestivalNos, festival.festivalNo)}
                                            ? ' bg-yellow-300 border-yellow-400 text-gray-900'
                                            : ' bg-white border-gray-300 text-gray-700'"
                                        th:text="${favoriteFestivalNos != null and #sets.contains(favoriteFestivalNos, festival.festivalNo)}
                                            ? '‚òÖ'
                                            : '‚òÜ'">
                                </button>
                            </form>
                        </div>

                        <!-- 2-2-3. Ï£ºÏÜå -->
                        <p class="text-sm text-gray-600 mb-2" th:if="${festival.addr}">
                            <i class="fas fa-map-marker-alt"></i>
                            <span th:text="${festival.addr}">Ï£ºÏÜå</span>
                        </p>

                        <!-- 2-2-4. Í∏∞Í∞Ñ -->
                        <p class="text-sm text-gray-500 mb-2"
                           th:if="${festival.eventStartDate != null and festival.eventEndDate != null}">
                            <i class="fas fa-calendar"></i>
                            <span th:text="${#temporals.format(festival.eventStartDate, 'yyyy.MM.dd')}">ÏãúÏûëÏùº</span>
                            ~
                            <span th:text="${#temporals.format(festival.eventEndDate, 'yyyy.MM.dd')}">Ï¢ÖÎ£åÏùº</span>
                        </p>
                    </div> <!-- /Ï∂ïÏ†ú Ïπ¥Îìú -->

                </div> <!-- /.festival-items -->
            </div>     <!-- /#festivalListContainer -->

            <!-- 3. Ï†ÑÏ≤¥ Ï∂ïÏ†ú ÎßàÏª§Ïö© Ïà®Í≤®ÏßÑ Ïπ¥ÎìúÎì§ (Ïπ¥Ïπ¥Ïò§ÎßµÏóêÏÑú ÏÇ¨Ïö©) -->
            <div id="allFestivalMarkers" class="hidden"
                 th:if="${mapFestivals != null}">
                <div th:each="festival : ${mapFestivals}"
                     class="marker-card"
                     th:data-festival-no="${festival.festivalNo}"
                     th:data-lat="${festival.mapy}"
                     th:data-lng="${festival.mapx}"
                     th:data-title="${festival.title}"
                     th:data-addr="${festival.addr}"
                     th:data-start="${festival.eventStartDate != null ? #temporals.format(festival.eventStartDate, 'yyyy.MM.dd') : ''}"
                     th:data-end="${festival.eventEndDate != null ? #temporals.format(festival.eventEndDate, 'yyyy.MM.dd') : ''}"
                     th:data-favorite="${favoriteFestivalNos != null and #sets.contains(favoriteFestivalNos, festival.festivalNo)}"
                     th:data-ai="${aiFestivalNos != null and #sets.contains(aiFestivalNos, festival.festivalNo)}"
                     th:data-image-url="${festival.images != null and !#lists.isEmpty(festival.images) ? festival.images[0].imageUrl : ''}"
                     th:data-tags="${tagMap != null and tagMap[festival.festivalNo] != null
                                     ? #strings.arrayJoin(tagMap[festival.festivalNo].![tag], ',')
                                     : ''}">
                </div>
            </div>

            <!-- 4. ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ Ï∂ïÏ†úÎßå Î≥¥Í∏∞ Ï≤¥ÌÅ¨Î∞ïÏä§ -->
            <div class="flex items-center mt-4 mb-2">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="ongoingOnlyCheckbox"
                           class="w-4 h-4 text-main border-gray-300 rounded focus:ring-main focus:ring-2 cursor-pointer"
                           th:checked="${ongoingOnly} ? 'checked' : null">
                    <span class="ml-2 text-sm text-gray-700">ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ Ï∂ïÏ†úÎßå Î≥¥Í∏∞</span>
                </label>
            </div>

            <!-- 5. ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
            <div id="pagination"
                 th:if="${festivalList != null and !festivalList.isEmpty()}"
                 class="flex justify-center items-center gap-1.5 mt-4 mx-auto"
                 style="max-width: 80%;">

                <th:block th:with="
                    total=${festivalList.totalPages},
                    current=${festivalList.number},

                    startCalc=${current - 2},
                    start=${startCalc < 0 ? 0 : (startCalc > total - 5 ? total - 5 : startCalc)},

                    start=${start < 0 ? 0 : start},
                    endCalc=${start + 4},
                    end=${endCalc >= total ? total - 1 : endCalc}
                ">

                    <!-- Ïù¥Ï†Ñ -->
                    <a href="#"
                       th:data-page="${current - 1 < 0 ? 0 : current - 1}"
                       th:if="${current > 0}"
                       class="page-btn inline-flex items-center justify-center px-2 py-1.5 border rounded hover:bg-gray-100 cursor-pointer text-sm">
                        ‚óÄ
                    </a>
                    <span th:if="${current == 0}"
                          class="inline-flex items-center justify-center px-2 py-1.5 border rounded text-gray-400 cursor-pointer text-sm">
                        ‚óÄ
                    </span>

                    <!-- Ï≤´ ÌéòÏù¥ÏßÄ -->
                    <a href="#"
                       th:data-page="0"
                       th:if="${start > 0}"
                       class="page-btn inline-flex items-center justify-center px-2.5 py-1.5 border rounded hover:bg-gray-100 cursor-pointer text-sm">
                        1
                    </a>

                    <!-- Ïïû ... -->
                    <span th:if="${start > 1}" class="px-1 text-sm">...</span>

                    <!-- Î≤àÌò∏ Î≤ÑÌäº -->
                    <a th:each="i : ${#numbers.sequence(start, end)}"
                       href="#"
                       th:data-page="${i}"
                       th:text="${i + 1}"
                       th:class="${i == current}
                            ? 'page-btn inline-flex items-center justify-center px-2.5 py-1.5 rounded bg-main text-white cursor-pointer text-sm'
                            : 'page-btn inline-flex items-center justify-center px-2.5 py-1.5 border rounded hover:bg-gray-100 cursor-pointer text-sm'">
                    </a>

                    <!-- Îí§ ... -->
                    <span th:if="${end < total - 2}" class="px-1 text-sm">...</span>

                    <!-- ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ -->
                    <a href="#"
                       th:data-page="${total - 1}"
                       th:if="${end < total - 1}"
                       class="page-btn inline-flex items-center justify-center px-2.5 py-1.5 border rounded hover:bg-gray-100 cursor-pointer text-sm"
                       th:text="${total}">
                    </a>

                    <!-- Îã§Ïùå -->
                    <a href="#"
                       th:data-page="${current + 1 >= total ? total - 1 : current + 1}"
                       th:if="${current < total - 1}"
                       class="page-btn inline-flex items-center justify-center px-2 py-1.5 border rounded hover:bg-gray-100 cursor-pointer text-sm">
                        ‚ñ∂
                    </a>
                    <span th:if="${current >= total - 1}"
                          class="inline-flex items-center justify-center px-2 py-1.5 border rounded text-gray-400 cursor-pointer text-sm">
                        ‚ñ∂
                    </span>
                </th:block>
            </div>

        </div> <!-- /.w-full h-full -->
    </div> <!-- /fragment:festivalList -->
</body>
</html>
