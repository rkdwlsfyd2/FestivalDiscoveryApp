<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<head>
    <title>축제 캘린더</title>

    <th:block layout:fragment="css">
        <style>
            .calendar-day { min-height: 120px; }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content" class="qwert font-suit">

    <!-- 상단 타이틀 / 월 이동 / 지역 필터 -->
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-h1 font-bold">축제 캘린더</h1>
            <p class="text-subtext text-gray-500 mt-1">
                달력을 넘기며 원하는 달의 축제를 한눈에 확인해보세요.
            </p>
        </div>

        <div class="flex flex-col md:flex-row gap-3 md:items-center">
            <div class="flex items-center gap-2 justify-between md:justify-end">
                <a th:href="@{/calendar(year=${prevYear}, month=${prevMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    ◀ 이전 달
                </a>
                <div class="text-h3 font-semibold text-main mx-1">
                    <span th:text="${year}">2025</span>.
                    <span th:text="${month}">11</span>
                </div>
                <a th:href="@{/calendar(year=${nextYear}, month=${nextMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    다음 달 ▶
                </a>
            </div>

            <!-- 지역 필터 -->
            <form method="get" th:action="@{/calendar}" class="flex items-center gap-2">
                <input type="hidden" name="year" th:value="${year}">
                <input type="hidden" name="month" th:value="${month}">
                <select name="region"
                        class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-main">
                    <option value="">전체 지역</option>
                    <option th:each="r : ${regions}"
                            th:value="${r}"
                            th:text="${r}"
                            th:selected="${selectedRegion == r}">
                    </option>
                </select>
                <button type="submit"
                        class="px-3 py-1.5 bg-main text-foreground text-sm rounded-lg shadow hover:opacity-90">
                    적용
                </button>
            </form>
        </div>
    </div>

    <!-- 달력 그리드 -->
    <div class="mt-6 bg-white rounded-2xl shadow-md overflow-hidden">
        <!-- 요일 헤더 -->
        <div class="grid grid-cols-7 bg-sub-blue text-foreground text-center text-subtext py-2 font-medium">
            <div class="text-red-500">일</div>
            <div>월</div>
            <div>화</div>
            <div>수</div>
            <div>목</div>
            <div>금</div>
            <div class="text-blue-500">토</div>
        </div>

        <!-- 날짜들 -->
        <div class="grid grid-cols-7 bg-sub-blue bg-opacity-10 gap-px">
            <div class="contents" th:each="week : ${weeks}">
                <div class="calendar-day bg-white p-2 flex flex-col border border-gray-100
                            hover:bg-sub-blue hover:bg-opacity-10 transition"
                     th:each="day : ${week}"
                     th:classappend="${!day.inMonth} ? ' opacity-40 bg-gray-50 hover:bg-gray-50'">

                    <!-- 날짜 숫자 -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold"
                              th:text="${day.date.dayOfMonth}">1</span>
                    </div>

                    <!-- 축제 개수 / 클릭 텍스트 -->
                    <div class="mt-2">
                        <span th:if="${#lists.size(day.festivals) > 0}"
                              class="text-[12px] text-main underline cursor-pointer festival-toggle"
                              th:data-date="${day.date}"
                              th:data-day-id="'day-' + ${day.date}">
                            <span th:text="${#lists.size(day.festivals)}">0</span>개의 축제
                        </span>

                        <span th:if="${#lists.size(day.festivals) == 0}"
                              class="text-[11px] text-gray-400">
                            축제 없음
                        </span>
                    </div>

                    <!-- 이 날짜의 축제 목록(숨김; 클릭 시 아래 상세 패널에 복사해서 사용) -->
                    <div th:id="'day-' + ${day.date}" class="hidden">
                        <div th:each="festival : ${day.festivals}"
                             class="flex items-center justify-between py-1">
                            <a th:href="@{/festival/detail(festivalNo=${festival.festivalNo})}"
                               class="text-sm font-medium hover:underline"
                               th:text="${festival.title}">
                                축제 이름
                            </a>
<!--                            <div class="flex gap-1 ml-2">-->
<!--                                <img th:each="tagImg : ${festival.tagImageUrls}"-->
<!--                                     th:src="${tagImg}"-->
<!--                                     alt="태그"-->
<!--                                     class="w-5 h-5 rounded-full object-cover border border-gray-200">-->
<!--                            </div>-->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 아래에 선택된 날짜의 축제 목록 표시 영역 -->
    <div id="festivalDetail" class="mt-6 bg-white rounded-2xl shadow-md p-4 hidden">
        <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-main" id="detailDateText">선택한 날짜의 축제 목록</div>
            <button type="button" id="detailCloseBtn"
                    class="text-xs text-gray-400 hover:text-gray-600">
                닫기 ✕
            </button>
        </div>
        <div id="detailContent" class="divide-y divide-gray-100">
            <!-- JS로 각 날짜의 hidden 목록을 복사해서 여기에 넣음 -->
        </div>
    </div>

    <div class="mt-4 text-subtext text-gray-500">
        날짜 아래의 "<b>n개의 축제</b>" 텍스트를 클릭하면, 해당 날짜의 축제 목록과 태그를 아래에서 확인할 수 있습니다.
    </div>

</div>

<!-- 스크립트 -->
<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const detailPanel = document.getElementById('festivalDetail');
            const detailContent = document.getElementById('detailContent');
            const detailDateText = document.getElementById('detailDateText');
            const closeBtn = document.getElementById('detailCloseBtn');

            // 날짜별 "n개의 축제 존재함" 클릭 이벤트
            document.querySelectorAll('.festival-toggle').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const dayId = this.dataset.dayId;
                    const src = document.getElementById(dayId);
                    if (!src) return;

                    // 해당 날짜의 숨겨진 목록을 상세 패널에 복사
                    detailContent.innerHTML = src.innerHTML;

                    const dateStr = this.dataset.date; // yyyy-MM-dd 형태
                    detailDateText.textContent = dateStr + ' 진행 축제 목록';

                    detailPanel.classList.remove('hidden');
                    detailPanel.scrollIntoView({behavior: 'smooth', block: 'start'});
                });
            });

            // 닫기 버튼
            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    detailPanel.classList.add('hidden');
                });
            }
        });
    </script>
</th:block>

</body>
</html>
