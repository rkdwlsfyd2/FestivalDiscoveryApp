<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<head>

    <title>ì¶•ì œ ìº˜ë¦°ë”</title>

    <th:block layout:fragment="css">
        <style>
            .calendar-day {
                min-height: 120px;
                border-left: 1px solid #e5e7eb;
                border-bottom: 1px solid #e5e7eb;
            }

            /* ìš”ì¼ í—¤ë” ì•„ë˜ ë‚ ì§œ ê·¸ë¦¬ë“œëŠ” gap 0ìœ¼ë¡œ â€” ì¤„ ëŠê¹€ ìµœì†Œí™” */
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, minmax(0, 1fr));
                gap: 0;
            }

            .festival-bar {
                position: relative;
                z-index: 1;
                color: #111827;
            }

            /* barType ì— ë”°ë¥¸ ëª¨ì„œë¦¬ ì²˜ë¦¬ */
            .festival-bar[data-bar-type="SINGLE"] {
                border-radius: 9999px;
                margin-left: 10px;
                margin-right: 10px;
            }

            .festival-bar[data-bar-type="START"] {
                margin-left: 10px;
                border-top-left-radius: 9999px;
                border-bottom-left-radius: 9999px;
            }

            .festival-bar[data-bar-type="MIDDLE"] {
                border-radius: 0;
            }

            .festival-bar[data-bar-type="END"] {
                margin-right: 10px;
                border-top-right-radius: 9999px;
                border-bottom-right-radius: 9999px;
            }
        </style>
    </th:block>

</head>

<body>
<div layout:fragment="content" class="qwert font-suit">

    <!-- ìƒë‹¨ íƒ€ì´í‹€ / ì›” ì´ë™ / ì§€ì—­ í•„í„° -->
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-h1 font-bold">ì¶•ì œ ìº˜ë¦°ë”</h1>
            <p class="text-subtext text-gray-500 mt-1 bg-gray-200">
                <span>ğŸŒ¿ ìì—°</span>
                <span>ğŸŒ™ ì•¼ê°„</span>
                <span>ğŸ¨ ì²´í—˜</span>
                <span>ğŸœ ë¨¹ê±°ë¦¬</span>
                <span>ğŸ­ ë¬¸í™”</span>
                <span>ğŸ‘¦ ì•„ë™</span>
                <span>â„ï¸ ê³„ì ˆ</span>
            </p>
        </div>

        <div class="flex flex-col md:flex-row gap-3 md:items-center">
            <div class="flex items-center gap-2 justify-between md:justify-end">
                <a th:href="@{/calendar(year=${prevYear}, month=${prevMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    â—€ ì´ì „ ë‹¬
                </a>
                <div class="text-h3 font-semibold text-main mx-1">
                    <span th:text="${year}">2025</span>.
                    <span th:text="${month}">11</span>
                </div>
                <a th:href="@{/calendar(year=${nextYear}, month=${nextMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    ë‹¤ìŒ ë‹¬ â–¶
                </a>
            </div>

            <!-- ì§€ì—­ í•„í„° -->
            <form method="get" th:action="@{/calendar}" class="flex items-center gap-2">
                <input type="hidden" name="year" th:value="${year}">
                <input type="hidden" name="month" th:value="${month}">
                <select name="region"
                        class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-main">
                    <option value="">ì „ì²´ ì§€ì—­</option>
                    <option th:each="r : ${regions}"
                            th:value="${r}"
                            th:text="${r}"
                            th:selected="${selectedRegion == r}">
                    </option>
                </select>
                <button type="submit"
                        class="px-3 py-1.5 bg-main text-foreground text-sm rounded-lg shadow hover:opacity-90">
                    ì ìš©
                </button>
            </form>
        </div>
    </div>

    <!-- ë‹¬ë ¥ + ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ ì»¨í…Œì´ë„ˆ -->
    <div class="mt-6 flex flex-col md:flex-row gap-4 items-start">

        <!-- ë‹¬ë ¥ ê·¸ë¦¬ë“œ (ì¢Œì¸¡) -->
        <div class="flex-1 bg-white rounded-2xl shadow-md overflow-hidden">
            <!-- ìš”ì¼ í—¤ë” -->
            <div class="grid grid-cols-7 bg-sub-blue text-foreground text-center text-subtext py-2 font-medium">
                <div class="text-red-500">ì¼</div>
                <div>ì›”</div>
                <div>í™”</div>
                <div>ìˆ˜</div>
                <div>ëª©</div>
                <div>ê¸ˆ</div>
                <div class="text-blue-500">í† </div>
            </div>

            <!-- ë‚ ì§œë“¤ -->
            <div class="calendar-grid bg-sub-blue bg-opacity-10 gap-0">
                <div class="contents" th:each="week : ${weeks}">
                    <div class="calendar-day bg-white py-2 px-0 flex flex-col
                                hover:bg-sub-blue hover:bg-opacity-10 transition"
                         th:each="day : ${week}"
                         th:classappend="${!day.inMonth ? ' opacity-40 bg-gray-50 hover:bg-gray-50' :
                                         (day.date.equals(today) ? ' bg-sub-blue bg-opacity-30' : '')}">

                        <!-- ë‚ ì§œ ìˆ«ì -->
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold"
                                  th:text="${day.date.dayOfMonth}">1</span>
                        </div>

                        <!-- ì¦ê²¨ì°¾ê¸° ì¶•ì œ ë°” (êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼) -->
                        <div class="mt-1 relative"
                             style="height: 80px;"
                             th:if="${#lists.size(day.festivals.?[favorite]) > 0}">

                            <div th:each="f : ${day.festivals.?[favorite]}"
                                 class="absolute left-0 right-0"
                                 th:style="|top: ${f.lane * 18}px;|">

                                <a class="festival-bar block h-4 text-[10px] px-1 truncate"
                                   th:attr="data-bar-type=${f.barType}"
                                   th:style="|background-color: ${f.colorCode};|">

                                    <span th:if="${f.showTitle}" th:text="${f.title}"></span>
                                </a>
                            </div>
                        </div>

                        <!-- ì¶•ì œ ê°œìˆ˜ / í´ë¦­ í…ìŠ¤íŠ¸ : ë‚ ì§œ ì¹¸ ë§¨ ì•„ë˜ ì¤‘ì•™ -->
                        <div class="mt-auto flex justify-center">
                            <span th:if="${#lists.size(day.festivals) > 0}"
                                  class="text-[11px] text-gray-400 cursor-pointer festival-toggle"
                                  th:data-date="${day.date}"
                                  th:data-day-id="'day-' + ${day.date}">
                                <span th:text="${#lists.size(day.festivals)}">0</span>ê°œì˜ ì¶•ì œ
                            </span>

                            <span th:if="${#lists.size(day.festivals) == 0}"
                                  class="text-[11px] text-gray-300">
                                <!-- ì¶•ì œê°€ ì—†ëŠ” ë‚ ì€ ì•„ë¬´ í…ìŠ¤íŠ¸ë„ í‘œì‹œí•˜ì§€ ì•Šê±°ë‚˜, 'ì¶•ì œ ì—†ìŒ' ë“±ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥ -->
                            </span>
                        </div>

                        <!-- ë‚ ì§œë³„ ì¶•ì œ ìƒì„¸ (ìˆ¨ê²¨ì§„ ì˜ì—­: ìš°ì¸¡ íŒ¨ë„ì— ë³µì‚¬í•´ì„œ ì‚¬ìš©) -->
                        <div th:id="'day-' + ${day.date}" class="hidden">
                            <div th:each="festival : ${day.festivals}"
                                 class="flex items-center justify-between py-1">

                                <div>
                                    <a th:href="@{/festivals/detail(festivalNo=${festival.festivalNo})}"
                                       class="text-sm font-medium hover:underline"
                                       th:text="${festival.title}"></a>

                                    <!-- ê¸°ê°„ í‘œì‹œ -->
                                    <div class="text-[11px] text-gray-500"
                                         th:text="${festival.periodText}"></div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <!-- íƒœê·¸ ì´ë¯¸ì§€ -->
                                    <div class="flex gap-1">
                                        <span th:each="tagImg : ${festival.tagImageUrls}"
                                             th:text="${tagImg}"
                                              class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 border"></span>
                                    </div>

                                    <!-- ì¦ê²¨ì°¾ê¸° í† ê¸€ ë²„íŠ¼ -->
                                    <form method="post" th:action="@{/favorite/toggle}">
                                        <input type="hidden" name="festivalNo"
                                               th:value="${festival.festivalNo}">
                                        <input type="hidden" name="redirectUrl"
                                               th:value="@{/calendar(year=${year}, month=${month}, region=${selectedRegion}, openDate=${day.date})}">

                                        <button type="submit"
                                                class="text-[11px] px-2 py-1 rounded-lg border"
                                                th:classappend="${festival.favorite} ? ' bg-yellow-300 border-yellow-400' : ' border-gray-300'"
                                                th:text="${festival.favorite} ? 'â˜…' : 'â˜†'">
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì„ íƒëœ ë‚ ì§œì˜ ì¶•ì œ ëª©ë¡ í‘œì‹œ ì˜ì—­ -->
        <div id="festivalDetail"
             class="w-full md:w-80 bg-white rounded-2xl shadow-md p-4 hidden md:block">
            <div class="flex items-center justify-between mb-3">
                <div class="font-semibold text-main" id="detailDateText">ì„ íƒí•œ ë‚ ì§œì˜ ì¶•ì œ ëª©ë¡</div>
            </div>
            <div id="detailContent" class="divide-y divide-gray-100">
                <!-- JSë¡œ ê° ë‚ ì§œì˜ hidden ëª©ë¡ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë„£ìŒ -->
            </div>
        </div>

    </div>

    <div class="mt-4 text-subtext text-gray-500">
        ë‚ ì§œ ì•„ë˜ì˜ "<b>nê°œì˜ ì¶•ì œ</b>" í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ë©´, í•´ë‹¹ ë‚ ì§œì˜ ì¶•ì œ ëª©ë¡ê³¼ íƒœê·¸ë¥¼
        <b>ìš°ì¸¡ íŒ¨ë„</b>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

</div>

<!-- JS (í† ê¸€, ìƒì„¸ íŒ¨ë„ ë“±) -->
<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // â–¶ ë‚ ì§œ í´ë¦­ ì‹œ ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ì— ëª©ë¡ ì¶œë ¥
            document.querySelectorAll('.festival-toggle').forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetId = this.dataset.dayId;
                    const src = document.getElementById(targetId);
                    if (!src) return;

                    document.getElementById('detailContent').innerHTML = src.innerHTML;
                    document.getElementById('detailDateText').textContent =
                        this.dataset.date + ' ì§„í–‰ ì¶•ì œ ëª©ë¡';

                    document.getElementById('festivalDetail').classList.remove('hidden');
                });
            });

            // â–¼ URLì— openDateê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ íŒ¨ë„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
            const params = new URLSearchParams(window.location.search);
            const openDate = params.get('openDate');
            if (openDate) {
                const btn = document.querySelector(`.festival-toggle[data-date="${openDate}"]`);
                if (btn) {
                    btn.click();   // í•´ë‹¹ ë‚ ì§œì˜ "nê°œì˜ ì¶•ì œ"ë¥¼ ê°•ì œë¡œ í´ë¦­í•´ì„œ ìš°ì¸¡ íŒ¨ë„ ë³µêµ¬
                }
            }


            // â–¶ ìƒì„¸ íŒ¨ë„ ë‹«ê¸°
            const closeBtn = document.getElementById('detailCloseBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById('festivalDetail').classList.add('hidden');
                });
            }

            // â–¶ ì¦ê²¨ì°¾ê¸° ë”ë³´ê¸° í† ê¸€ (í•„ìš” ì‹œ ì‚¬ìš©)
            const favToggle = document.getElementById('favMoreToggle');
            const favList = document.getElementById('favFullList');
            const favLabel = document.getElementById('favMoreLabel');

            if (favToggle && favList) {
                favToggle.addEventListener('click', () => {
                    const isHidden = favList.classList.contains('hidden');
                    favList.classList.toggle('hidden');
                    favLabel.textContent = isHidden ? 'ì ‘ê¸°' : 'ì „ì²´ ë³´ê¸°';
                });
            }

        });
    </script>
</th:block>

</body>
</html>
