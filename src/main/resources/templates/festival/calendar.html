<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<head>

    <th:block layout:fragment="css">
        <style>
            .calendar-day {
                min-height: 120px;
                border-left: 1px solid #e5e7eb;
                border-bottom: 1px solid #e5e7eb;
            }

            /* ìš”ì¼ í—¤ë” ì•„ë˜ ë‚ ì§œ ê·¸ë¦¬ë“œëŠ” gap 0ìœ¼ë¡œ â€” ì¤„ ëŠê¹€ ìµœì†Œí™” */
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, minmax(0, 1fr));
                gap: 0;
            }

            .festival-bar {
                position: relative;
                z-index: 1;
                color: #111827;
            }

            /* barType ì— ë”°ë¥¸ ëª¨ì„œë¦¬ ì²˜ë¦¬ */
            .festival-bar[data-bar-type="SINGLE"] {
                border-radius: 9999px;
                margin-left: 10px;
                margin-right: 10px;
            }

            .festival-bar[data-bar-type="START"] {
                margin-left: 10px;
                border-top-left-radius: 9999px;
                border-bottom-left-radius: 9999px;
            }

            .festival-bar[data-bar-type="MIDDLE"] {
                border-radius: 0;
            }

            .festival-bar[data-bar-type="END"] {
                margin-right: 10px;
                border-top-right-radius: 9999px;
                border-bottom-right-radius: 9999px;
            }
            #calendarBox {
                max-width: 1130px;
                margin-right: 12px;   /* ìº˜ë¦°ë”ì™€ ì˜¤ë¥¸ìª½ íŒ¨ë„ ì‚¬ì´ ì—¬ìœ  */
            }
        </style>
    </th:block>

</head>

<body>
<div layout:fragment="content" class="qwert font-suit">

    <!-- ìƒë‹¨ íƒ€ì´í‹€ / ì›” ì´ë™ / ì§€ì—­ í•„í„° -->
    <div class="flex flex-col items-center gap-3 mt-32">
        <h1 class="text-h1 font-black text-gradient mb-4">ì¶•ì œ ìº˜ë¦°ë”</h1>

        <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-center">
            <div class="flex items-center gap-2">
                <a th:href="@{/calendar(year=${prevYear}, month=${prevMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    â—€ ì´ì „ ë‹¬
                </a>
                <div class="text-h3 font-bold text-black mx-1">
                    <span th:text="${year}">2025</span>.
                    <span th:text="${month}">11</span>
                </div>
                <a th:href="@{/calendar(year=${nextYear}, month=${nextMonth}, region=${selectedRegion})}"
                   class="px-3 py-1.5 rounded-full border border-gray-300 text-sm bg-white hover:bg-gray-50">
                    ë‹¤ìŒ ë‹¬ â–¶
                </a>
            </div>

            <!-- ì§€ì—­ í•„í„° -->
            <form method="get" th:action="@{/calendar}" class="flex items-center gap-2">
                <input type="hidden" name="year" th:value="${year}">
                <input type="hidden" name="month" th:value="${month}">
                <select name="region"
                        class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-main">
                    <option value="">ì „ì²´ ì§€ì—­</option>
                    <option th:each="r : ${regions}"
                            th:value="${r}"
                            th:text="${r}"
                            th:selected="${selectedRegion == r}">
                    </option>
                </select>
                <button type="submit"
                        class="px-3 py-1.5 bg-main text-foreground text-sm rounded-lg hover:bg-gradient2 transition">
                    ì ìš©
                </button>
            </form>
        </div>
    </div>

    <!-- ë‹¬ë ¥ + ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ ì»¨í…Œì´ë„ˆ -->
    <div class="mt-6 mb-20 flex flex-col md:flex-row md:items-stretch md:justify-center">


    <!-- ë‹¬ë ¥ ê·¸ë¦¬ë“œ (ì¢Œì¸¡) -->
        <div id="calendarBox" class="flex-1 bg-white rounded-2xl shadow-md overflow-hidden">
            <!-- ìš”ì¼ í—¤ë” -->
            <div class="grid grid-cols-7 text-foreground text-center text-subtext font-medium">
                <div class="bg-sub-red py-2 border border-gray-200">ì¼</div>
                <div class="bg-gray-600 py-2 border border-gray-200">ì›”</div>
                <div class="bg-gray-600 py-2 border border-gray-200">í™”</div>
                <div class="bg-gray-600 py-2 border border-gray-200">ìˆ˜</div>
                <div class="bg-gray-600 py-2 border border-gray-200">ëª©</div>
                <div class="bg-gray-600 py-2 border border-gray-200">ê¸ˆ</div>
                <div class="bg-main py-2 border border-gray-200">í† </div>
            </div>

            <!-- ë‚ ì§œë“¤ -->
            <div class="calendar-grid bg-sub-blue bg-opacity-10 gap-0">
                <div class="contents" th:each="week : ${weeks}">
                    <div class="calendar-day bg-white py-2 px-0 flex flex-col border border-gray-200
                                hover:bg-sub-blue hover:bg-opacity-10 transition"
                         th:each="day : ${week}"
                         th:classappend="${!day.inMonth ? ' opacity-40 bg-gray-50 hover:bg-gray-50' :
                                         (day.date.equals(today) ? ' bg-sub-blue bg-opacity-30 cursor-pointer festival-toggle' : 'cursor-pointer festival-toggle')}"
                         th:attr="data-date=${day.date},
                                  data-day-id='day-' + ${day.date},
                                  data-istoday=${day.date.equals(today)}">

                        <!-- ë‚ ì§œ ìˆ«ì -->
                        <div class="flex items-center  px-2">
                            <span class="text-sm font-semibold  "
                                  th:text="${day.date.dayOfMonth}">1</span>

                            <!-- ì¶•ì œ ê°œìˆ˜ -->
                            <div class="flex-1 flex justify-center">
                                <span th:if="${#lists.size(day.festivals) > 0}"
                                      class="text-[11px] text-gradient "
                                      th:data-date="${day.date}"
                                      th:data-day-id="'day-' + ${day.date}">
                                    <span th:text="${#lists.size(day.festivals)}">0</span>ê°œì˜ ì¶•ì œ
                                </span>
                            </div>
                        </div>

                        <!-- ì¦ê²¨ì°¾ê¸° ì¶•ì œ ë°” (êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼) -->
                        <div class="mt-1 relative"
                             style="height: 80px;"
                             th:if="${#lists.size(day.festivals.?[favorite]) > 0}">

                            <div th:each="f, stat : ${day.festivals.?[favorite]}"
                                 th:if="${f.lane < 5}"
                                 class="absolute left-0 right-0"
                                 th:style="|top: ${f.lane * 17}px;|">

                                <a class="festival-bar block h-4 text-[10px] px-1 truncate"
                                   th:attr="data-bar-type=${f.barType}"
                                   th:style="|background-color: ${f.colorCode};|">

                                    <span th:if="${f.showTitle}" th:text="${f.title}"></span>
                                </a>
                            </div>
                        </div>



                        <!-- ë‚ ì§œë³„ ì¶•ì œ ìƒì„¸ (ìˆ¨ê²¨ì§„ ì˜ì—­: ìš°ì¸¡ íŒ¨ë„ì— ë³µì‚¬í•´ì„œ ì‚¬ìš©) -->
                        <div th:id="'day-' + ${day.date}" class="hidden">

                            <div th:each="festival : ${day.festivals}"
                                 class="flex items-center justify-between py-1">

                                <div>
                                    <a th:href="@{/festivals/detail(festivalNo=${festival.festivalNo})}"
                                       class="text-sm font-medium hover:underline"
                                       th:text="${festival.title}"></a>

                                    <!-- ê¸°ê°„ í‘œì‹œ -->
                                    <div class="text-[11px] text-gray-500"
                                         th:text="${festival.periodText}"></div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <!-- íƒœê·¸ ì´ë¯¸ì§€ -->
                                    <div class="flex gap-1">
                                        <span th:each="tagImg : ${festival.tagImageUrls}"
                                             th:text="${tagImg}"
                                              class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 border"></span>
                                    </div>

                                    <!-- ì¦ê²¨ì°¾ê¸° í† ê¸€ ë²„íŠ¼ -->
                                    <form method="post" th:action="@{/favorite/toggle}">
                                        <input type="hidden" name="festivalNo"
                                               th:value="${festival.festivalNo}">
                                        <input type="hidden" name="redirectUrl"
                                               th:value="@{/calendar(year=${year}, month=${month}, region=${selectedRegion}, openDate=${day.date})}">

                                        <button type="submit"
                                                class="text-[11px] px-2 py-1 rounded-lg border"
                                                th:classappend="${festival.favorite} ? ' bg-yellow-300 border-yellow-400' : ' border-gray-300'"
                                                th:text="${festival.favorite} ? 'â˜…' : 'â˜†'">
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì„ íƒëœ ë‚ ì§œì˜ ì¶•ì œ ëª©ë¡ í‘œì‹œ ì˜ì—­ -->
        <div id="festivalDetail"
             class="w-full md:w-80 bg-white rounded-2xl shadow-md hidden md:flex md:flex-col h-[755px] border border-gray-300 overflow-hidden">

            <!-- ìº˜ë¦°ë” ìš”ì¼ í—¤ë”ì²˜ëŸ¼ ë³´ì¼ ì˜ì—­ -->
            <div id="detailHeader" class="bg-main pt-1 pb-[6px] px-4 text-center font-medium sticky top-0 z-10">
                <div id="detailDateText" class="text-white">ì„ íƒí•œ ë‚ ì§œì˜ ì¶•ì œ ëª©ë¡</div>
            </div>

            <!-- ì‹¤ì œ ë‚´ìš© (p-4ë¡œ ë‚´ë¶€ ì—¬ë°± ì§€ì •) -->
            <div id="detailContent" class="p-4 pt-[1px] flex-1 overflow-y-auto">
                <div class="divide-y divide-gray-100 flex-1 pr-3">
                    <!-- JSë¡œ ê° ë‚ ì§œì˜ hidden ëª©ë¡ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë„£ìŒ -->
                </div>
            </div>
        </div>

    </div>

</div>

<!-- JS (í† ê¸€, ìƒì„¸ íŒ¨ë„ ë“±) -->
<th:block layout:fragment="script">
    <script>
        const legendHtml = `
            <div class="sticky top-0 bg-white z-20 py-1">
                <p class="text-subtext text-black bg-gray-200">
                    <span>ğŸŒ¿ ìì—°</span>
                    <span>ğŸŒ™ ì•¼ê°„</span>
                    <span>ğŸ¨ ì²´í—˜</span>
                    <span>ğŸœ ë¨¹ê±°ë¦¬</span>
                    <span>ğŸ­ ë¬¸í™”</span><br>
                    <span>ğŸ‘¦ ì•„ë™</span>
                    <span>â„ï¸ ê³„ì ˆ</span>
                </p>
            </div>
        `;

        document.addEventListener('DOMContentLoaded', function () {
            let selectedCell = null;

            function selectCell(cell) {
                // ì´ì „ ì„ íƒ í•´ì œ
                if (selectedCell) {
                    selectedCell.classList.remove('bg-sub-blue', 'bg-opacity-30');
                }
                // ìƒˆ ì„ íƒ ì ìš©
                selectedCell = cell;
                selectedCell.classList.add('bg-sub-blue', 'bg-opacity-30');
            }

            // â–¶ ë‚ ì§œ ì¹¸ í´ë¦­ ì‹œ ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ì— ëª©ë¡ ì¶œë ¥
            document.querySelectorAll('.calendar-day.festival-toggle').forEach(cell => {
                cell.addEventListener('click', function () {
                    const targetId = this.dataset.dayId;
                    const src = document.getElementById(targetId);
                    if (!src) return;

                    document.getElementById('detailContent').innerHTML =
                        legendHtml + src.innerHTML;
                    document.getElementById('detailDateText').textContent =
                        this.dataset.date + ' ì§„í–‰ ì¶•ì œ ëª©ë¡';

                    document.getElementById('festivalDetail').classList.remove('hidden');

                    // ì„ íƒëœ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬
                    selectCell(this);
                });
            });

            // â–¼ URLì— openDateê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ ì¹¸ì„ ë¨¼ì € í´ë¦­
            const params = new URLSearchParams(window.location.search);
            const openDate = params.get('openDate');
            if (openDate) {
                const cell = document.querySelector(
                    `.calendar-day.festival-toggle[data-date="${openDate}"]`
                );
                if (cell) {
                    cell.click();
                    return; // ì˜¤ëŠ˜ ë‚ ì§œ ìë™í´ë¦­ì€ ê±´ë„ˆëœ€
                }
            }

            // â–¼ ì²˜ìŒ ì§„ì… ì‹œ, ì˜¤ëŠ˜ ë‚ ì§œê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ í´ë¦­
            const todayCell = document.querySelector(
                '.calendar-day.festival-toggle[data-istoday="true"]'
            );
            if (todayCell) {
                todayCell.click();
            }
        });
    </script>
</th:block>

</body>
</html>
