<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">

<head>
    <title>관리자 대시보드</title>

    <th:block layout:fragment="css">
        <style>
            .dashboard-title {
                font-size: 1.5rem;
                font-weight: 700;
            }

            .card {
                border-radius: 0.75rem;
                border: 1px solid #e5e7eb;
                background-color: #ffffff;
                padding: 1.5rem;
            }

            .card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .card-title {
                font-size: 0.95rem;
                font-weight: 600;
            }

            .card-subtitle {
                font-size: 0.8rem;
                color: #6b7280;
            }

            .stat-value {
                font-size: 1.4rem;
                font-weight: 700;
            }

            .stat-label {
                font-size: 0.8rem;
                color: #6b7280;
            }

            .badge-primary {
                display: inline-flex;
                align-items: center;
                padding: 0.15rem 0.5rem;
                font-size: 0.7rem;
                border-radius: 9999px;
                background-color: #eff6ff;
                color: #1d4ed8;
            }

            .section-title {
                font-size: 1.05rem;
                font-weight: 600;
            }

            .section-subtitle {
                font-size: 0.8rem;
                color: #6b7280;
            }

            .table-header {
                font-size: 0.78rem;
                color: #6b7280;
            }

            .pill {
                display: inline-flex;
                align-items: center;
                padding: 0.15rem 0.5rem;
                border-radius: 9999px;
                background-color: #f3f4f6;
                font-size: 0.75rem;
            }

            .pill-dot {
                width: 0.4rem;
                height: 0.4rem;
                border-radius: 9999px;
                margin-right: 0.25rem;
            }

            .pill-dot-green {
                background-color: #22c55e;
            }

            .pill-dot-amber {
                background-color: #f59e0b;
            }

            .pill-dot-red {
                background-color: #ef4444;
            }

            .trend-up {
                color: #16a34a;
                font-size: 0.75rem;
            }

            .trend-down {
                color: #ef4444;
                font-size: 0.75rem;
            }
        </style>
    </th:block>
</head>

<body>

<div layout:fragment="content" class="p-6 space-y-6">

    <!-- 사이드바 (대시보드와 동일하게) -->
    <aside class="w-60 bg-white shadow-md rounded-lg p-6 mr-8">
        <h2 class="text-xl font-bold mb-6">관리자 페이지</h2>

        <nav class="flex flex-col space-y-3">
            <a href="/admin"
               class="px-3 py-2 rounded-md"
               th:classappend="${activeMenu} == 'dashboard' ? ' bg-gray-200 font-semibold' : ' hover:bg-gray-100'">
                대시보드
            </a>

            <a href="/admin/members"
               class="px-3 py-2 rounded-md"
               th:classappend="${activeMenu} == 'members' ? ' bg-gray-200 font-semibold' : ' hover:bg-gray-100'">
                회원 관리
            </a>

            <a href="/admin/festivals"
               class="px-3 py-2 rounded-md"
               th:classappend="${activeMenu} == 'festivals' ? ' bg-gray-200 font-semibold' : ' hover:bg-gray-100'">
                축제 관리
            </a>

            <a href="/admin/reviews"
               class="px-3 py-2 rounded-md"
               th:classappend="${activeMenu} == 'reviews' ? ' bg-gray-200 font-semibold' : ' hover:bg-gray-100'">
                리뷰 관리
            </a>
        </nav>
    </aside>

    <!-- 상단 타이틀 -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="dashboard-title">관리자 대시보드</h1>
            <p class="text-sm text-gray-500 mt-1">
                전체 회원 현황, 축제/리뷰 통계, 트래픽 요약을 한 눈에 확인할 수 있습니다.
            </p>
        </div>
        <div class="text-xs text-gray-500">
            마지막 업데이트 :
            <span th:text="${#temporals.format(stats.lastUpdated, 'yyyy-MM-dd HH:mm')}">
                2025-11-24 04:00
            </span>
        </div>
    </div>

    <!-- 1. 핵심 통계 카드 4개 -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <!-- 전체 회원 수 -->
        <div class="card flex flex-col justify-between">
            <div class="card-header">
                <div>
                    <div class="card-title">전체 회원 수</div>
                    <div class="card-subtitle">탈퇴 회원 제외, 활성 계정 기준</div>
                </div>
                <span class="badge-primary">회원</span>
            </div>
            <div class="flex items-end justify-between mt-3">
                <div>
                    <div class="stat-value" th:text="${#numbers.formatInteger(stats.totalMembers, 0, 'COMMA')}">
                        1,234
                    </div>
                    <div class="stat-label mt-1">
                        오늘 가입
                        <span class="text-main font-semibold"
                              th:text="${stats.todaySignups}">5</span>명
                    </div>
                </div>
                <div class="text-right">
                    <div class="trend-up"
                         th:if="${stats.memberGrowthRate >= 0}"
                         th:text="'지난달 대비 +' + ${#numbers.formatDecimal(stats.memberGrowthRate, 1, 1)} + '%'">
                        +12.3%
                    </div>
                    <div class="trend-down"
                         th:if="${stats.memberGrowthRate < 0}"
                         th:text="'지난달 대비 ' + ${#numbers.formatDecimal(stats.memberGrowthRate, 1, 1)} + '%'">
                        -3.2%
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        이번 주 가입
                        <span th:text="${stats.weekSignups}">32</span>명
                    </div>
                </div>
            </div>
        </div>

        <!-- 전체 축제 수 -->
        <div class="card flex flex-col justify-between">
            <div class="card-header">
                <div>
                    <div class="card-title">전체 축제 수</div>
                    <div class="card-subtitle">DB에 등록된 모든 축제</div>
                </div>
                <span class="badge-primary">축제</span>
            </div>
            <div class="flex items-end justify-between mt-3">
                <div>
                    <div class="stat-value"
                         th:text="${#numbers.formatInteger(stats.totalFestivals, 0, 'COMMA')}">
                        856
                    </div>
                    <div class="stat-label mt-1">
                        현재 진행중
                        <span class="font-semibold"
                              th:text="${stats.activeFestivals}">42</span>개
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">
                        이번 달 예정
                        <span class="font-semibold"
                              th:text="${stats.thisMonthFestivals}">78</span>개
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        데이터 최신화 :
                        <span th:text="${stats.festivalSyncSource}">한국관광공사 API</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 전체 리뷰 수 -->
        <div class="card flex flex-col justify-between">
            <div class="card-header">
                <div>
                    <div class="card-title">전체 리뷰 수</div>
                    <div class="card-subtitle">사용자가 남긴 리뷰 현황</div>
                </div>
                <span class="badge-primary">리뷰</span>
            </div>
            <div class="flex items-end justify-between mt-3">
                <div>
                    <div class="stat-value"
                         th:text="${#numbers.formatInteger(stats.totalReviews, 0, 'COMMA')}">
                        3,214
                    </div>
                    <div class="stat-label mt-1">
                        평균 평점
                        <span class="font-semibold"
                              th:text="${#numbers.formatDecimal(stats.avgReviewScore, 1, 1)}">4.5</span>점
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">
                        오늘 작성된 리뷰
                        <span class="font-semibold"
                              th:text="${stats.todayReviews}">12</span>건
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        신고 처리 대기
                        <span class="text-red-500 font-semibold"
                              th:text="${stats.pendingReviewReports}">3</span>건
                    </div>
                </div>
            </div>
        </div>

        <!-- 즐겨찾기 / 트래픽 요약 -->
        <div class="card flex flex-col justify-between">
            <div class="card-header">
                <div>
                    <div class="card-title">즐겨찾기 & 트래픽</div>
                    <div class="card-subtitle">플랫폼 이용 현황</div>
                </div>
                <span class="badge-primary">트래픽</span>
            </div>
            <div class="flex flex-col gap-2 mt-3 text-sm">
                <div class="flex items-center justify-between">
                    <span class="stat-label">전체 즐겨찾기 수</span>
                    <span class="font-semibold"
                          th:text="${#numbers.formatInteger(stats.totalFavorites, 0, 'COMMA')}">
                        4,520
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="stat-label">오늘 페이지 조회수(PV)</span>
                    <span class="font-semibold"
                          th:text="${#numbers.formatInteger(stats.todayPageViews, 0, 'COMMA')}">
                        2,341
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="stat-label">현재 접속 중인 사용자</span>
                    <span class="font-semibold"
                          th:text="${stats.onlineUsers}">7</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="stat-label">오늘 최고 동접자 수</span>
                    <span class="font-semibold"
                          th:text="${stats.maxOnlineToday}">21</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 회원 / 축제 요약 (2열) -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- 회원 요약 -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="section-title">회원 요약</div>
                    <div class="section-subtitle">
                        최근 가입 회원 및 회원 활동 현황입니다.
                    </div>
                </div>
            </div>

            <!-- 상단 집계 카드 -->
            <div class="grid grid-cols-2 gap-4">
                <div class="card">
                    <div class="text-xs text-gray-500 mb-1">오늘 가입</div>
                    <div class="flex items-end justify-between">
                        <div class="stat-value"
                             th:text="${stats.todaySignups}">5</div>
                        <div class="trend-up"
                             th:if="${stats.todaySignupsDelta >= 0}"
                             th:text="'어제보다 +' + ${stats.todaySignupsDelta} + '명'">
                            +2명
                        </div>
                        <div class="trend-down"
                             th:if="${stats.todaySignupsDelta < 0}"
                             th:text="'어제보다 ' + ${stats.todaySignupsDelta} + '명'">
                            -1명
                        </div>
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        7일 평균
                        <span th:text="${stats.weeklyAvgSignups}">4</span>명
                    </div>
                </div>

                <div class="card">
                    <div class="text-xs text-gray-500 mb-1">이번 주 리뷰 수</div>
                    <div class="flex items-end justify-between">
                        <div class="stat-value"
                             th:text="${stats.weekReviews}">32</div>
                        <div class="text-[0.7rem] text-gray-400">
                            신고된 리뷰
                            <span class="text-red-500 font-semibold"
                                  th:text="${stats.reportedReviewsThisWeek}">1</span>건
                        </div>
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        평균 평점
                        <span th:text="${#numbers.formatDecimal(stats.weekAvgReviewScore,1,1)}">4.3</span>점
                    </div>
                </div>
            </div>

            <!-- 최근 가입 회원 테이블 -->
            <div class="card">
                <div class="flex items-center justify-between mb-3">
                    <div class="font-semibold">최근 가입 회원</div>
                    <div class="text-xs text-gray-400">
                        최근
                        <span th:text="${#lists.size(stats.recentMembers)}">5</span>명
                        가입
                    </div>
                </div>
                <table class="w-full text-xs">
                    <thead class="border-b table-header">
                    <tr class="text-left">
                        <th class="py-2">닉네임</th>
                        <th class="py-2">이메일</th>
                        <th class="py-2">가입일</th>
                        <th class="py-2 text-center">상태</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m : ${stats.recentMembers}" class="border-b text-[0.78rem]">
                        <td class="py-2 font-medium" th:text="${m.name}">닉네임</td>
                        <td class="py-2 text-gray-600" th:text="${m.email}">user@example.com</td>
                        <td class="py-2"
                            th:text="${#temporals.format(m.joinDate, 'yyyy-MM-dd ')}">
                            2025-11-23 21:10
                        </td>
                        <td class="py-2 text-center">
                            <span class="pill">
                                <span class="pill-dot pill-dot-green"
                                      th:if="${m.status == 'ACTIVE'}"></span>
                                <span class="pill-dot pill-dot-amber"
                                      th:if="${m.status == 'SUSPENDED'}"></span>
                                <span class="pill-dot pill-dot-red"
                                      th:if="${m.status == 'WITHDRAWN'}"></span>
                                <span th:text="${m.statusLabel}">정상</span>
                            </span>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(stats.recentMembers)}">
                        <td colspan="4" class="py-4 text-center text-gray-400">
                            최근 가입한 회원이 없습니다.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 축제 요약 -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="section-title">축제 요약</div>
                    <div class="section-subtitle">
                        등록된 축제 및 최근 등록 축제 현황입니다.
                    </div>
                </div>
            </div>

            <!-- 상단 집계 카드 -->
            <div class="grid grid-cols-2 gap-4">
                <div class="card">
                    <div class="text-xs text-gray-500 mb-1">오늘 시작하는 축제</div>
                    <div class="flex items-end justify-between">
                        <div class="stat-value"
                             th:text="${stats.todayStartFestivals}">3</div>
                        <div class="text-[0.7rem] text-gray-400">
                            오늘 종료
                            <span th:text="${stats.todayEndFestivals}">2</span>개
                        </div>
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-1">
                        이번 주 총
                        <span th:text="${stats.weekFestivals}">15</span>개 진행
                    </div>
                </div>

                <div class="card">
                    <div class="text-xs text-gray-500 mb-1">즐겨찾기 인기 축제 TOP 1</div>
                    <div class="mt-1">
                        <div class="font-semibold text-sm truncate">
                        <span th:text="${stats.topFavoriteFestival != null ? stats.topFavoriteFestival.title : '아직 즐겨찾기된 축제가 없습니다.'}">
                            아직 즐겨찾기된 축제가 없습니다.
                        </span>
                        </div>
                        <div class="text-[0.75rem] text-gray-500 mt-1">
                            즐겨찾기
                            <span class="font-semibold"
                                  th:text="${stats.topFavoriteFestival != null ? stats.topFavoriteFestival.favoriteCount : 0}">124</span>회
                        </div>
                    </div>
                    <div class="text-[0.7rem] text-gray-400 mt-2">
                        주요 지역 :
                        <span th:text="${stats.topFestivalStates}">경북, 서울, 부산</span>
                    </div>
                </div>
            </div>

            <!-- 최근 등록 축제 테이블 -->
            <div class="card">
                <div class="flex items-center justify-between mb-3">
                    <div class="font-semibold">최근 등록 축제</div>
                    <div class="text-xs text-gray-400">
                        최근
                        <span th:text="${#lists.size(stats.recentFestivals)}">5</span>개
                        등록
                    </div>
                </div>
                <table class="w-full text-xs">
                    <thead class="border-b table-header">
                    <tr class="text-left">
                        <th class="py-2">축제명</th>
                        <th class="py-2">지역</th>
                        <th class="py-2">기간</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${stats.recentFestivals}" class="border-b text-[0.78rem]">
                        <td class="py-2 font-medium truncate" th:text="${f.title}">
                            축제 제목
                        </td>
                        <td class="py-2 text-gray-600" th:text="${f.state}">
                            서울
                        </td>
                        <td class="py-2"
                            th:text="${#temporals.format(f.eventStartDate,'yyyy-MM-dd')} + ' ~ ' + #temporals.format(f.eventEndDate,'yyyy-MM-dd')">
                            2025-11-01 ~ 2025-11-05
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(stats.recentFestivals)}">
                        <td colspan="3" class="py-4 text-center text-gray-400">
                            최근 등록된 축제가 없습니다.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. 주간 추이 / 시스템 요약 (2열) -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- 주간 가입/리뷰 추이 -->
        <div class="card">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="font-semibold">주간 가입/리뷰 추이</div>
                    <div class="section-subtitle">
                        최근 7일 동안의 신규 가입자와 리뷰 수입니다.
                    </div>
                </div>
            </div>

            <div class="space-y-2 text-xs">
                <div class="flex items-center justify-between text-gray-500 mb-1">
                    <span>날짜</span>
                    <span>가입자 / 리뷰</span>
                </div>

                <div th:each="d : ${stats.weeklyStats}" class="flex items-center gap-3">
                    <span class="w-12"
                          th:text="${#temporals.format(d.date,'MM/dd')}">
                        11/18
                    </span>
                    <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <!-- 가입자 막대 -->
                        <div class="h-full bg-main/70 inline-block"
                             th:style="'display:inline-block;width:' + (${d.signupCount} * 6) + 'px'"></div>
                        <!-- 리뷰 막대 (조금 진한 색상이라고 가정) -->
                        <div class="h-full bg-main inline-block"
                             th:style="'display:inline-block;width:' + (${d.reviewCount} * 4) + 'px'"></div>
                    </div>
                    <span class="w-14 text-right text-gray-700">
                        <span th:text="${d.signupCount}">5</span> /
                        <span th:text="${d.reviewCount}">3</span>
                    </span>
                </div>

                <div th:if="${#lists.isEmpty(stats.weeklyStats)}"
                     class="py-4 text-center text-gray-400">
                    주간 통계 데이터가 없습니다.
                </div>
            </div>
        </div>

        <!-- 시스템 / 트래픽 요약 -->
        <div class="card">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="font-semibold">시스템 / 트래픽 요약</div>
                    <div class="section-subtitle">
                        간단한 서버 상태와 트래픽 정보를 제공합니다.
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-xs">
                <div class="space-y-2">
                    <div class="font-semibold text-gray-700">세션 현황</div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">현재 세션 수</span>
                        <span class="font-semibold"
                              th:text="${stats.activeSessions}">12</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">오늘 생성된 세션</span>
                        <span class="font-semibold"
                              th:text="${stats.todayNewSessions}">34</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">세션 타임아웃(분)</span>
                        <span class="font-semibold"
                              th:text="${stats.sessionTimeoutMinutes}">30</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="font-semibold text-gray-700">트래픽 요약</div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">오늘 방문자(고유)</span>
                        <span class="font-semibold"
                              th:text="${stats.todayUniqueVisitors}">120</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">전체 방문 수</span>
                        <span class="font-semibold"
                              th:text="${#numbers.formatInteger(stats.totalVisits, 0, 'COMMA')}">
                            12,345
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500">평균 응답 시간(ms)</span>
                        <span class="font-semibold"
                              th:text="${stats.avgResponseTimeMs}">180</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

</body>
</html>
